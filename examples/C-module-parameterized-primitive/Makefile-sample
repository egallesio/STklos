# SPDX-License-Identifier: GPL-3.0-or-later
#                                                    -*- mode: makefile -*-
#
#
# Makefile for example code to create C primitives that accepts a parameter,
# similar to Scheme closures.
#
# This is a simple Makefile, given here as an example. We try here to have
# something simple, which can easily understood (this file is a bit simpler
# than the Makefile generated by the GNU autotools, which is used when
# compile the STklos package, and can be used without a prior STklos
# installation).
#
# We suppose here that Stklos has been previously installed.
#
#
#           Author: Jeronimo Pellegrini [j_p@aleph0.info]
#    Creation date: 25-Mar-2025 10:11 (jpellegrini)

# STKLOS_SRC is the directory with the C source of STklos.
# Since this example is in 'examples/c-module', then the
# 'src' subdir is this:
STKLOS_SRC=../../src/

# The following variables are:
# SCHEME_SOURCE -- the Scheme part of the module
# C_INCL        -- C file to be included (generated by stklos-compile)
# C_SOURCE      -- C module source, written by the user
# C_OBJ         -- C object file (intermediate)
# SHARED_OBJ    -- C shared object (loadable library)

SCHEME_SOURCE=descriptive-statistics.stk
C_INCL=descriptive-statistics-incl.c
C_SOURCE=descriptive-statistics.c
C_OBJ=descriptive-statistics.o
SHARED_OBJ=descriptive-statistics.so

# Instead of making a compact Makefile that uses wildcards and variable names,
# we opted for using the filenames in the Maefile rule heads, and the
# variables above in the rule bodies. This could, perhaps, make it somewhat
# easier for beginners to understand the file.

all: $(SHARED_OBJ)

# We first compile the Scheme file descriptive-statistics.stk into a C file
# descriptive-statistics-incl.c, so it will be included in the library C file
# later:
descriptive-statistics-incl.c: $(SCHEME_SOURCE) $(C_INCL)
	stklos-compile -c --no-time \
	-C \
	--output=$(C_INCL) \
	$(SCHEME_SOURCE)

# Now we compile the C library, which will include descriptive-statistics-incl.c.
# The compiler flags are:
# -fpic is of course necessary
# -nostdlib, becaues STklos is already linked against libc
# -c compile only, don't link
descriptive-statistics.o: $(C_SOURCE) $(C_INCL)
	$(CC) -g -O2 -fpic -nostdlib \
	-I$(STKLOS_SRC) \
	-c \
	-o $(C_OBJ) \
	$(C_SOURCE)

# And finally, we make it a shared library so STklos will be
# able to load it:
descriptive-statistics.so: $(C_OBJ)
	$(LD) -shared  -o $(SHARED_OBJ) $(C_OBJ)

clean:
	rm -f \
	descriptive-statistics-incl.c \
	descriptive-statistics-incl.o \
	descriptive-statistics.o \
	descriptive-statistics.so
