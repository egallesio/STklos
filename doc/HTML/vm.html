<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<meta name="author" content="Jeronimo Pellegrini">
<title>The STklos Virtual Machine</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock pre>code{display:block}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cm {
  color: #75715e;
  font-style: italic;
}
pre.rouge .c1 {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cp {
  color: #75715e;
  font-weight: bold;
}
pre.rouge .cs {
  color: #75715e;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .err {
  color: #960050;
  background-color: #1e0010;
}
pre.rouge .gi {
  color: #ffffff;
  background-color: #324932;
}
pre.rouge .gd {
  color: #ffffff;
  background-color: #493131;
}
pre.rouge .ge {
  font-style: italic;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .k, pre.rouge .kv {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kc {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kd {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kp {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kr {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kt {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kn {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .ow {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .o {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .mf {
  color: #ae81ff;
}
pre.rouge .mh {
  color: #ae81ff;
}
pre.rouge .il {
  color: #ae81ff;
}
pre.rouge .mi {
  color: #ae81ff;
}
pre.rouge .mo {
  color: #ae81ff;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #ae81ff;
}
pre.rouge .se {
  color: #ae81ff;
}
pre.rouge .sa {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .sb {
  color: #e6db74;
}
pre.rouge .sc {
  color: #e6db74;
}
pre.rouge .sd {
  color: #e6db74;
}
pre.rouge .s2 {
  color: #e6db74;
}
pre.rouge .sh {
  color: #e6db74;
}
pre.rouge .si {
  color: #e6db74;
}
pre.rouge .sx {
  color: #e6db74;
}
pre.rouge .sr {
  color: #e6db74;
}
pre.rouge .s1 {
  color: #e6db74;
}
pre.rouge .ss {
  color: #e6db74;
}
pre.rouge .s, pre.rouge .dl {
  color: #e6db74;
}
pre.rouge .na {
  color: #a6e22e;
}
pre.rouge .nc {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nd {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .ne {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .no {
  color: #66d9ef;
}
pre.rouge .bp {
  color: #f8f8f2;
}
pre.rouge .nb {
  color: #f8f8f2;
}
pre.rouge .ni {
  color: #f8f8f2;
}
pre.rouge .nn {
  color: #f8f8f2;
}
pre.rouge .vc {
  color: #f8f8f2;
}
pre.rouge .vg {
  color: #f8f8f2;
}
pre.rouge .vi {
  color: #f8f8f2;
}
pre.rouge .nv, pre.rouge .vm {
  color: #f8f8f2;
}
pre.rouge .w {
  color: #f8f8f2;
}
pre.rouge .nl {
  color: #f8f8f2;
  font-weight: bold;
}
pre.rouge .nt {
  color: #f92672;
}
pre.rouge {
  color: #f8f8f2;
  background-color: #49483e;
}
</style>
<style>
  /* Customize default CSS */
  .sidebarblock { margin-top: -1em; }
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>The STklos Virtual Machine</h1>
<div class="details">
<span id="author" class="author">Jeronimo Pellegrini</span><br>
<span id="email" class="email"><a href="mailto:j_p@aleph0.info">j_p@aleph0.info</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_the_bytecode">1. The bytecode</a></li>
<li><a href="#_value_register">2. Value register</a></li>
<li><a href="#_stack">3. Stack</a></li>
<li><a href="#_local_variables">4. Local variables</a></li>
<li><a href="#_deep_variables">5. Deep variables</a></li>
<li><a href="#_global_variables">6. Global variables</a>
<ul class="sectlevel2">
<li><a href="#_uglobal_refset_and_the_checked_global_variables">6.1. UGLOBAL_{REF,SET} and the checked global variables</a></li>
</ul>
</li>
<li><a href="#_operations">7. Operations</a>
<ul class="sectlevel2">
<li><a href="#_arithmetic">7.1. Arithmetic</a></li>
<li><a href="#_increment_and_decrement_val">7.2. Increment and decrement val</a></li>
<li><a href="#_comparisons">7.3. Comparisons</a></li>
<li><a href="#_constructors">7.4. Constructors</a></li>
<li><a href="#_structure_references">7.5. Structure references</a></li>
</ul>
</li>
<li><a href="#_control_flow">8. Control flow</a></li>
<li><a href="#_closures_let_and_related">9. Closures, let, and related</a>
<ul class="sectlevel2">
<li><a href="#_let">9.1. let</a></li>
</ul>
</li>
<li><a href="#_miscelannea">10. Miscelannea</a>
<ul class="sectlevel2">
<li><a href="#_creating_closures_and_procedures">10.1. Creating closures and procedures</a></li>
<li><a href="#_procedure_calls">10.2. Procedure calls</a></li>
</ul>
</li>
<li><a href="#_modules">11. Modules</a></li>
<li><a href="#_vm_c">12. <code>vm.c</code></a>
<ul class="sectlevel2">
<li><a href="#_the_global_lock">12.1. The global lock</a></li>
<li><a href="#_run_vmvm_thread_vm">12.2. <code>run_vm(vm_thread *vm)</code></a></li>
</ul>
</li>
<li><a href="#_continuations">13. Continuations</a>
<ul class="sectlevel3">
<li><a href="#_capturing_a_continuation">13.1. Capturing a continuation</a></li>
<li><a href="#_restoring_a_continuation">13.2. Restoring a continuation</a></li>
</ul>
</li>
<li><a href="#_verifying_the_vm_configuration">14. Verifying the VM configuration</a></li>
<li><a href="#_collecting_statistics">15. Collecting statistics</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is the documentation for the opcodes of the STklos virtual machine.
The VM implementation is contained in the files <code>src/vm.h</code> and
<code>src/vm.c</code>.</p>
</div>
<div class="paragraph">
<p>The VM has a stack, which in the source code is accessed using the C
functions <code>push(elt)</code> and <code>pop()</code>. Each VM thread also has:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_instr *pc</code>, the program counter</p>
</li>
<li>
<p><code>SCM *fp</code>, the frame pointer</p>
</li>
<li>
<p><code>SCM *sp</code>, the Scheme stack pointer</p>
</li>
<li>
<p><code>SCM *stack</code>, the Scheme stack</p>
</li>
<li>
<p><code>int stack_len</code>, the length of the stack</p>
</li>
<li>
<p><code>SCM val</code>, a register for the current value</p>
</li>
<li>
<p><code>SCM vals[]</code>, a register for multiple values</p>
</li>
<li>
<p><code>int valc</code>, the number of multiple values</p>
</li>
<li>
<p><code>SCM r1, r2</code> two registers</p>
</li>
<li>
<p><code>SCM env</code>, the current environment</p>
</li>
<li>
<p><code>SCM current_module</code>, the current module</p>
</li>
<li>
<p><code>SCM iport, oport, eport</code>, the current input, output and error ports</p>
</li>
<li>
<p><code>SCM scheme_thread</code>, the Scheme thread associated with this thread</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of these, only a few are relevant to understanding the bytecode – these
are the value registers and the stack.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_bytecode">1. The bytecode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>STklos bytecode is a sequence of 16-bit integers. You can see the
opcodes of a compiled thunk with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="o">...</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and the opcodes of an expression with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="ss">'expr</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With an extra <code>#t</code> argument, <code>dissasemble-proc</code> will show constants:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="s">"abc"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CONSTANT             0
002:</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="s">"abc"</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CONSTANT             0
002:

Constants:
0: "abc"</pre>
</div>
</div>
<div class="paragraph">
<p>When we make a closure with the lambda, we’ll always see a <code>RETURN</code> at
the end of the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="o">'</span><span class="p">()</span> <span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-NIL
001:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, one opcode loads the <code>NIL</code> value to the register
and another opcode `RETURN`s. This return is from the lambda.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_value_register">2. Value register</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simpler opcodes are those that carry with them an immediate value.
These operations will copy their value to the <code>val</code> register in the VM.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IM_FALSE
IM_TRUE
IM_NIL
IM_MINUS1
IM_ZERO
IM_ONE
IM_VOID</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span>  <span class="mi">1</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-ONE</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>  <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="no">#f</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-FALSE
001:  IM-ONE
002:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>Opcodes for small integers and constants do the same, but they take a
little longer to execute, since they need to perform some small
operations.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SMALL_INT
CONSTANT</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span>  <span class="mi">5</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  SMALL-INT            5</pre>
</div>
</div>
<div class="paragraph">
<p>Small integers are <em>not</em> the same as fixnums! A small integer is an
integer number that fits in 16 bits (that is, in one bytecode element).
The fixnum range depends on the size of <code>long</code> in the platform being
used.</p>
</div>
<div class="paragraph">
<p>Suppose STklos has been compiled on a 64 bit system and also ona 32 bit
system. The ranges for small ints and fixnums are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>small integer (on both): [ -2^15, +2^15 - 1 ]
fixnum (long is 32-bit): [ -2^29, +2^29 - 1 ]
fixnum (long is 64-bit): [ -2^61, +2^61 - 1 ]</pre>
</div>
</div>
<div class="paragraph">
<p>The expression above, <code>5</code>, is compiled into the bytes</p>
</div>
<div class="literalblock">
<div class="content">
<pre>00 08 00 05</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>00 08</code> is the opcode for <code>`small int'', and `00 05</code> is the
argument (the small integer, 5).</p>
</div>
<div class="paragraph">
<p>Small integers are compiled <em>into</em> the bytecode. Fixnums, bignums,
strings are stored <em>outside</em> of the bytecode, and the instruction
<code>CONSTANT</code> takes as argument an index into the constants vector.</p>
</div>
<div class="paragraph">
<p>The expression <code>50000</code> is not a small integer, so it is compiled as a
constant:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(disassemble-expr 50000 #t)
000:  CONSTANT             0
002:

Constants:
0: 50000</pre>
</div>
</div>
<div class="paragraph">
<p>Zero is the index of <code>50000</code> in the constants vector.</p>
</div>
<div class="paragraph">
<p>The above code is compiled into bytecode as</p>
</div>
<div class="literalblock">
<div class="content">
<pre>00 09 00 00</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>00 09</code> means <code>CONSTANT</code> and <code>00 00</code> is the index into the
constants vector.</p>
</div>
<div class="paragraph">
<p>Another clarifying example:</p>
</div>
<div class="paragraph">
<p>(disassemble-expr ’(values 50000 ``abc'') #t)</p>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  CONSTANT-PUSH        0
003:  CONSTANT-PUSH        1
005:  GREF-INVOKE          2 2
008:

Constants:
0: 50000
1: "abc"
2: values</pre>
</div>
</div>
<div class="paragraph">
<p>The bytecode is</p>
</div>
<div class="literalblock">
<div class="content">
<pre>37 85 0 85 1 86 2 2</pre>
</div>
</div>
<div class="paragraph">
<p>Here,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>85 0</code> is <code>CONSTANT-PUSH 0</code> (0 = first element of the vector)</p>
</li>
<li>
<p><code>85 1</code> is <code>CONSTANT-PUSH 1</code> (1 = second element)</p>
</li>
<li>
<p><code>86 2 2</code> is <code>GREF-INVOKE 2 2</code> (2 = number, arg to `values, next 2 =
third element of vector)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stack">3. Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following opcodes are similar to the immediate-value ones, except
that, instead of copying their values to the <code>val</code> register, they push
the value on the stack.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>FALSE_PUSH
TRUE_PUSH
NIL_PUSH
MINUS1_PUSH
ZERO_PUSH
ONE_PUSH
VOID_PUSH

INT_PUSH
CONSTANT_PUSH</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>POP</code> and <code>PUSH</code> move objects between stack and value register.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>POP     ; move top of stack to val register
PUSH    ; store val register on top of stack</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_local_variables">4. Local variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>LOCAL_REF</code> opcodes will load the values of variables from the
current environment (the <code>`local'' variables) on the `val</code> register.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>LOCAL_REF0
LOCAL_REF1
LOCAL_REF2
LOCAL_REF3
LOCAL_REF4
LOCAL_REF</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span><span class="p">)</span> <span class="nv">a</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF0
001:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">a</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF1
001:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>There are opcodes for five fixed positions only, so after that another
opcode, <code>LOCAL_REF</code>, needs an argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span> <span class="nv">c</span> <span class="nv">d</span> <span class="nv">e</span> <span class="nv">f</span><span class="p">)</span> <span class="nv">a</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF            5
002:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>The following opcodes are similar to the local reference ones, except
that, instead of copying their values to the <code>val</code> register, they push
the value on the stack.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>LOCAL_REF0_PUSH
LOCAL_REF1_PUSH
LOCAL_REF2_PUSH
LOCAL_REF3_PUSH
LOCAL_REF4_PUSH</pre>
</div>
</div>
<div class="paragraph">
<p>The following opcodes are analogous to the local reference ones, but
instead of loading values, they store the value of the <code>val</code> register on
the local variables</p>
</div>
<div class="literalblock">
<div class="content">
<pre>LOCAL_SET0
LOCAL_SET1
LOCAL_SET2
LOCAL_SET3
LOCAL_SET4
LOCAL_SET</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deep_variables">5. Deep variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Variables which are visible but not in the immediately accessible
environment are accessed with the <code>DEEP</code> opcodes.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>DEEP_LOCAL_REF
DEEP_LOCAL_SET
DEEP_LOC_REF_PUSH</pre>
</div>
</div>
<div class="paragraph">
<p>STklos organizes local environments as this: each level has a maximum
of 256 variables. Both the level and the address of local variables
are encoded in a single 16-bit integer, as "256v1+v2".  For example,
2*256 + 03 = 0x0203. The first byte, 0x02, identifies the level, and
the second byte, 0x03, identifies the variable.</p>
</div>
<div class="paragraph">
<p>The VM will, then, do something like this to access a deep local variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c">  <span class="cm">/* See this is src/vm.c, CASE(DEEP_LOCAL_REF):  */</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="n">FIRST_BYTE</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="n">level</span><span class="p">;</span> <span class="n">level</span><span class="o">--</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">SCM</span><span class="p">)</span> <span class="n">FRAME_NEXT</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

  <span class="n">vm</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">FRAME_LOCAL</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">SECOND_BYTE</span><span class="p">(</span><span class="n">info</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>info</code> is the information to access the variable (a <code>uint16_t</code>
number, as every opcode and operand used in the VM).
<code>FIRST_BYTE</code> gets the level; <code>SECOND_BYTE</code> gets the var address.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">10</span><span class="p">))</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="nv">a</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  DEEP-LOCAL-REF       256
002:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">10</span><span class="p">))</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
     <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="mi">20</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  SMALL-INT            20
002:  DEEP-LOCAL-SET       256
004:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, the value of <code>a</code> is fetched from a deep
environment and pushed onto the stack, so it can be used by the
comparison opcode <code>IN-NUMEQ</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">10</span><span class="p">))</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
     <span class="p">(</span><span class="nb">=</span> <span class="nv">a</span> <span class="mi">20</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  DEEP-LOC-REF-PUSH    256
002:  SMALL-INT            20
004:  IN-NUMEQ
005:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows a variable in a deeper level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">c</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">b</span> <span class="mi">3</span><span class="p">))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">2</span><span class="p">))</span>
        <span class="nv">c</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  INT-PUSH             2
003:  ENTER-TAIL-LET       1
005:  DEEP-LOCAL-REF       513
007:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>The number 513 is composed of the bytes 0x02 and 0x01:
<code>#x0201 = 513</code>. This means "the variable of index 1 in
level 2" (index 1 is for <code>c</code>, and index 0 is for <code>b</code>).</p>
</div>
<div class="paragraph">
<p>The code for <code>(let ((c 4) (b 3)</code> is not shown, but it can bee seen
with <code>disassemble-expr</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span>
  <span class="o">'</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">c</span> <span class="mi">4</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">b</span> <span class="mi">3</span><span class="p">))</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">2</span><span class="p">))</span>
         <span class="nv">c</span><span class="p">)))</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  INT-PUSH             4
003:  INT-PUSH             3
005:  ENTER-LET            2
007:  CREATE-CLOSURE       9 0	;; ==&gt; 018
010:  PREPARE-CALL
011:  INT-PUSH             2
013:  ENTER-TAIL-LET       1
015:  DEEP-LOCAL-REF       513
017:  RETURN
018:  LEAVE-LET</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_global_variables">6. Global variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Global variables can be read and set with the following opcodes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>GLOBAL-REF
GLOBAL-SET</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="ss">'my-cool-global-variable</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0

Constants:
0: my-cool-global-variable</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="k">set!</span> <span class="nv">my-cool-global-variable</span> <span class="no">#f</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-FALSE
001:  GLOBAL-SET           0

Constants:
0: my-cool-global-variable</pre>
</div>
</div>
<div class="sect2">
<h3 id="_uglobal_refset_and_the_checked_global_variables">6.1. UGLOBAL_{REF,SET} and the checked global variables</h3>
<div class="paragraph">
<p>Internally, the global variables values of a program are stored in a unique
array called <code>STk_global_store</code>.</p>
</div>
<div class="paragraph">
<p>The instructions <code>GLOBAL_REF</code> and <code>GLOBAL_SET</code> do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Fetch the name of the global variable</p>
</li>
<li>
<p>Lookup the variable in the current environment (that is, consult a hash table
in a module)</p>
</li>
<li>
<p>Verify if the variable is mutable or not</p>
</li>
<li>
<p>Finally, do the real get or set operation in <code>STk_global_store</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Steps 1-3 are quite expensive, and shouldn&#8217;t need to be done every time the
variable is accessed. Thus, the STklos VM patches the original code when
we are sure that the variable used is properly defined. Hence, he first time a
variable is referenced, the VM goes through all those steps, adds a final step:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p><strong>Patch the code</strong>, that is, changing the <code>GLOBAL_REF</code> or <code>GLOBAL_SET</code> instruction
into a <code>UGLOBAL_REF</code> or <code>UGLOBAL_SET</code> ('U' prefix here is for already <strong>U</strong>sed vrariable)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, in <code>GLOBAL_SET</code>, this step is performed by the following two lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c">  <span class="cm">/* patch the code for optimize next accesses */</span>
  <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_var_index</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span> <span class="c1">// ref: result of the search in the hash table</span>
  <span class="n">vm</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">UGLOBAL_SET</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See that what is being changed are the two previous bytecode elements,
<code>pc[-1]</code> and <code>pc[-2]</code>. Note that the value returned by <code>global_var_index</code> is
the index in <code>STk_global_store</code> where the used variable is stored.</p>
</div>
<div class="paragraph">
<p>So the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">test</span><span class="p">)</span> <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>is translated in</p>
</div>
<div class="listingblock">
<div class="content">
<pre>000:  CREATE-CLOSURE       6 0  ;; ==&gt; 008
003:  SMALL-INT            2
005:  GLOBAL-SET           0
007:  RETURN
008:  DEFINE-SYMBOL        1
010:

Constants:
0: a
1: test</pre>
</div>
</div>
<div class="paragraph">
<p>The second and third lines are used for doing this assignment. We can see that
the parameter of the <code>GLOBAL_SET</code> instruction is the name of the variable to
be set.</p>
</div>
<div class="paragraph">
<p>Then, after the first time the <code>GLOBAL_SET</code> instruction is performed, the
code will <strong>patch itself</strong> and changed into</p>
</div>
<div class="listingblock">
<div class="content">
<pre>000:  SMALL-INT            2
002:  UGLOBAL-SET          n</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>n</code> is the index of this global variable in the <code>STk_global_store</code>
array.</p>
</div>
<div class="paragraph">
<p>The instruction <code>GLOBAL_SET</code> takes two integers to be represented, so
when <code>pc[-1]</code> and <code>pc[-2]</code> are changed, what is being changed is the
previous argument (<code>0</code> &#8594; <code>n</code>) and the previous instruction
(<code>GLOBAL_SET</code> &#8594; <code>UGLOBAL_SET</code>).</p>
</div>
<div class="paragraph">
<p><strong>And</strong>, of course, the <code>n</code>-th element of the table contains the value of the
variable to be set. We can see this by disassembling the <code>test</code> function defined
before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>stklos&gt; (disassemble test)
000:  SMALL-INT            2
002:  GLOBAL-SET           0
004:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>Once <code>test</code> has been called at least one time, its code is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>stklos&gt; (disassemble test)
000:  SMALL-INT            2
002:  UGLOBAL-SET          2971
004:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>2971</code> is the index of the global variable <code>a</code> in the array of global
variables.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see now the code of <code>UGLOBAL_SET</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">CASE</span><span class="p">(</span><span class="n">UGLOBAL_SET</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Never produced by compiler */</span>
  <span class="cm">/* Because of optimization, we may get re-dispatched to here. */</span>
  <span class="n">RELEASE_POSSIBLE_LOCK</span><span class="p">;</span>

  <span class="n">fetch_global</span><span class="p">()</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span> <span class="n">NEXT0</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>fetch_global</code> macro is defined earlier in <code>vm.c</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#define fetch_next()     (*(vm-&gt;pc)++)
#define fetch_global()   (STk_global_store[(unsigned) fetch_next()])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RELEASE_POSSIBLE_LOCK</code> used here is a macro which deals with the lock
needed to patch the code. This lock is necessary since STklos permits to
have several threads to execute the same code. All the stuff about locking in
the VM is explained in <code>vm.c</code> source file, and is covered (a bit) below.</p>
</div>
<div class="paragraph">
<p>Of course, all the work detailed about how we optimize access to global
variables is also done in all other <code>UGREF_*</code> instructions in a similar way.</p>
</div>
<div class="paragraph">
<p>That is why, even using a hash table, access to global variables happens
with speed not too far from that of access to local variables in STklos.
This can be seen in the following rudimentary benchmark:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="c1">;;;</span>
<span class="c1">;;; Using locals: runs in about 3900ms</span>
<span class="c1">;;;</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">b</span> <span class="mi">2</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">time</span>
    <span class="p">(</span><span class="nf">repeat</span> <span class="mi">100</span><span class="nv">_000_000</span>
      <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))))</span>

<span class="c1">;;;</span>
<span class="c1">;;; Using globals: runs in about the same time (probably a bit faster)</span>
<span class="c1">;;;</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">a</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">b</span> <span class="mi">2</span><span class="p">)</span>

<span class="p">(</span><span class="nf">time</span>
  <span class="p">(</span><span class="nf">repeat</span> <span class="mi">100</span><span class="nv">_000_000</span>
     <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operations">7. Operations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_arithmetic">7.1. Arithmetic</h3>
<div class="paragraph">
<p>The operations take the top of stack and <code>val</code> as operands, and leave
the result on <code>val</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_ADD2
IN_SUB2
IN_MUL2
IN_DIV2</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">+</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0
002:  IN-SINT-ADD2         3

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>First the value of <code>a</code> (which is the zero-th local variable) is pushed
onto the stack. Then, <code>DEEP-LOCAL-REF</code> brings the value of <code>x</code>, and
<code>IM-ADD2</code> adds the two values, leaving the result on the local variable
register.</p>
</div>
<div class="paragraph">
<p>For fixnums, the analogous opcodes are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_FXADD2
IN_FXSUB2
IN_FXMUL2
IN_FXDIV2</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nf">fx+</span> <span class="nv">v</span> <span class="mi">3</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0
002:  IN-SINT-FXADD2       3

Constants:
0: v</pre>
</div>
</div>
<div class="paragraph">
<p>The following variant of those opcodes do not use the stack. They
operate on <code>val</code> and an argument:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_SINT_ADD2
IN_SINT_SUB2
IN_SINT_MUL2
IN_SINT_DIV2</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">+</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0
002:  IN-SINT-ADD2         2

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>With <code>a</code> as a local variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF0
001:  IN-SINT-ADD2         2
003:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>First, the value of <code>a</code> is put on <code>val</code>; then it is summed with <code>2</code>,
which comes as an argument to the opcode <code>IN-SINT-ADD2</code>.</p>
</div>
<div class="paragraph">
<p>These also have fixnum variants:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_SINT_FXADD2
IN_SINT_FXSUB2
IN_SINT_FXMUL2
IN_SINT_FXDIV2</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nf">fx+</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0
002:  IN-SINT-FXADD2       2

Constants:
0: a</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_increment_and_decrement_val">7.2. Increment and decrement val</h3>
<div class="literalblock">
<div class="content">
<pre>IN_INCR
IN_DECR</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_comparisons">7.3. Comparisons</h3>
<div class="paragraph">
<p>These compare the top of stack with <code>val</code>, and leave a boolean on <code>val</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_NUMEQ     ;   pop() == val ?
IN_NUMDIFF   ; ! pop() == val ?
IN_NUMLT     ;   pop &lt; val ?
IN_NUMGT     ;   pop &gt; val ?
IN_NUMLE     ;   pop &lt;= val ?
IN_NUMGE     ;   pop &gt;= val ?</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF-PUSH      0
002:  SMALL-INT            2
004:  IN-NUMGE

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>There are also opcodes for <code>equal?</code>, <code>eqv?</code> and <code>eq?</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_EQUAL
IN_EQV
IN_EQ</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">eq?</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF-PUSH      0
002:  SMALL-INT            2
004:  IN-EQ

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>dissassemble</code> procedures will not, however, show the names of
symbols or values of strings (<code>disassemble-expr</code> does, when passed the
extra <code>#t</code> argument).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">a</span> <span class="ss">'hello-i-am-a-symbol</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF0-PUSH
001:  CONSTANT             0
003:  IN-EQ
004:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">eq?</span> <span class="nv">a</span> <span class="ss">'hello-i-am-a-symbol</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF-PUSH      0
002:  CONSTANT             1
004:  IN-EQ
005:

Constants:
0: a
1: hello-i-am-a-symbol</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructors">7.4. Constructors</h3>
<div class="paragraph">
<p>These will build structures with the value in <code>val</code> and store the
structure (that is, the tagged word representing it) again on <code>val</code>.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_CONS
IN_CAR
IN_CDR
IN_CXR
IN_LIST</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">cons</span> <span class="s">"a"</span> <span class="s">"b"</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CONSTANT-PUSH        0
002:  CONSTANT             1
004:  IN-CONS
005:

Constants:
0: "a"
1: "b"</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF1-PUSH
001:  LOCAL-REF0
002:  IN-CONS
003:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>The element to be consed is pushed on the stack; then the second element
is loaded on <code>val</code>, and then <code>IN-CONS</code> is called.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">a</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  LOCAL-REF0-PUSH
001:  IN-LIST              1
003:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="nv">a</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  GLOBAL-REF           0
002:  IN-CAR
003:

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>The special accessor <code>CXR</code> is used to access list parts, as described
in the <code>cxr</code> library in the R7RS standard (<code>caar</code>, <code>cadr</code>, &#8230;&#8203;, up to
<code>cddddr</code>). The following example illustrates this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">caadr</span> <span class="nv">x</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span>

<span class="mi">000</span><span class="nv">:</span>  <span class="nv">GLOBAL-REF</span>           <span class="mi">1</span>
<span class="mi">002</span><span class="nv">:</span>  <span class="nv">IN-CXR</span>               <span class="mi">0</span>
<span class="mi">004</span><span class="nv">:</span>

<span class="nv">Constants:</span>
<span class="mi">0</span><span class="nv">:</span> <span class="o">#</span><span class="nv">:daa</span>
<span class="mi">1</span><span class="nv">:</span> <span class="nv">x</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The constant <code>#:daa</code> is the abbreviation of the operations --<code>(CAADR x)</code>
 = <code>(CAR (CAR (CDR x)))</code>, <strong>in reversed order</strong> (because that is the order in which they
will be applied, and it is more natural for the VM to go from the
beginning of the string towards the end.</p>
</div>
<div class="paragraph">
<p>See that if we turn off the inlining of functions in the compiler, we
get a different output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">compiler:inline-common-functions</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">caadr</span> <span class="nv">x</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span>

<span class="mi">000</span><span class="nv">:</span>  <span class="nv">PREPARE-CALL</span>
<span class="mi">001</span><span class="nv">:</span>  <span class="nv">GLOBAL-REF</span>           <span class="mi">0</span>
<span class="mi">003</span><span class="nv">:</span>  <span class="nv">PUSH</span>
<span class="mi">004</span><span class="nv">:</span>  <span class="nv">GLOBAL-REF</span>           <span class="mi">1</span>
<span class="mi">006</span><span class="nv">:</span>  <span class="nv">INVOKE</span>               <span class="mi">1</span>
<span class="mi">008</span><span class="nv">:</span>

<span class="nv">Constants:</span>
<span class="mi">0</span><span class="nv">:</span> <span class="nv">x</span>
<span class="mi">1</span><span class="nv">:</span> <span class="nv">caadr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not only we have more instructions, but the <code>PREPARE-CALL</code> and
<code>INVOKE</code> instructions above are rather expensive.</p>
</div>
</div>
<div class="sect2">
<h3 id="_structure_references">7.5. Structure references</h3>
<div class="paragraph">
<p>The following opcodes access and set elements of strings and vectors.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>IN_VREF
IN_SREF
IN_VSET
IN_SSET</pre>
</div>
</div>
<div class="paragraph">
<p><code>V</code> stands for vector, <code>S</code> stands for string; then, <code>REF</code> and <code>SET</code> mean
<code>reference'' and </code>set''.</p>
</div>
<div class="paragraph">
<p>The instructions will use the object in the stack and the index from the
<code>val</code> register.</p>
</div>
<div class="paragraph">
<p>Examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="o">#</span><span class="p">(</span><span class="nf">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)))</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">vector-ref</span> <span class="nv">a</span> <span class="mi">2</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  DEEP-LOC-REF-PUSH    256
002:  SMALL-INT            2
004:  IN-VREF
005:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, the <code>CONSTANT-PUSH</code> is including a reference
to the string on the stack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">string-ref</span> <span class="s">"abcde"</span> <span class="mi">3</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CONSTANT-PUSH        0
002:  SMALL-INT            3
004:  IN-SREF
005:

Constants:
0: "abcde"</pre>
</div>
</div>
<div class="paragraph">
<p>When setting a value, the reference to the vector or string and the
index go on the stack (index below the reference to the object – the
index is popped first), and the value goes on <code>val</code>, then the setting
opcode is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">v</span> <span class="p">(</span><span class="nb">vector</span> <span class="o">#</span><span class="nv">a</span> <span class="o">#</span><span class="nv">b</span> <span class="o">#</span><span class="nv">c</span><span class="p">)))</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">vector-set!</span> <span class="nv">v</span> <span class="mi">2</span> <span class="mi">10</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  DEEP-LOC-REF-PUSH    256    ; push ref. to vector
002:  INT-PUSH             2      ; push index
004:  SMALL-INT            10     ; put new value in val
006:  IN-VSET                     ; set it!
007:  RETURN</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_control_flow">8. Control flow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following opcodes have an argument, which is the offset to be added
to the program counter.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>GOTO           ; unconditionally jump
JUMP_TRUE      ; jump if val is true
JUMP_FALSE     ; jump if val is false
JUMP_NUMDIFF   ; jump if ! pop() = val (for numbers)
JUMP_NUMEQ     ; jump if pop() = val (for numbers)
JUMP_NUMLT     ; jump of pop() &lt;  val
JUMP_NUMLE     ; jump of pop() &lt;= val
JUMP_NUMGT     ; jump of pop() &gt;  val
JUMP_NUMGE     ; jump of pop() &gt;= val
JUMP_NOT_EQ    ; jump if pop() not eq? val
JUMP_NOT_EQV   ; jump if pop() not eqv? val
JUMP_NOT_EQUAL ; jump if pop() not equal? val</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="k">if</span> <span class="no">#t</span> <span class="mi">2</span> <span class="mi">4</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-TRUE
001:  JUMP-FALSE           3    ;; ==&gt; 006
003:  SMALL-INT            2
005:  RETURN
006:  SMALL-INT            4
008:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>STklos’ <code>disassemble</code> is nice enough to tell you the line number where a
jump goes!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closures_let_and_related">9. Closures, let, and related</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_let">9.1. let</h3>
<div class="paragraph">
<p>The opcodes for <code>`entering `let&#8217;' create new environments and push them
on the stack, but do <em>not</em> update activation records, since there is no
procedure call happening. Then, the `LEAVE_LET</code> opcode removes the
environment from the stack.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ENTER_LET
ENTER_LET_STAR
ENTER_TAIL_LET
ENTER_TAIL_LET_STAR
LEAVE_LET</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">x</span> <span class="mi">1</span><span class="p">))</span>
                           <span class="nv">x</span><span class="p">))</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  ONE-PUSH
002:  ENTER-LET            1
004:  LOCAL-REF0
005:  LEAVE-LET
006:  PUSH
007:  IN-LIST              1

Constants:</pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>let</code> is in tail position, then the opcode used is the ordinary
<code>ENTER_TAIL_LET</code>, and no <code>LEAVE_LET</code> is needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
   <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">x</span> <span class="mi">1</span><span class="p">))</span>
     <span class="nv">x</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  INT-PUSH             4
002:  ENTER-TAIL-LET       1
004:  LOCAL-REF0
005:  RETURN</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_miscelannea">10. Miscelannea</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following opcode does nothing:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>NOP</pre>
</div>
</div>
<div class="paragraph">
<p>The following sets the docstring and the formal parameter list
documentation for a procedure:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>DOCSTRG
FORMALS</pre>
</div>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">f</span><span class="p">)</span> <span class="s">"A well-documented function"</span> <span class="mi">5</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CREATE-CLOSURE       4 0  ;; ==&gt; 006
003:  SMALL-INT            5
005:  RETURN
006:  DOCSTRG              0
008:  DEFINE-SYMBOL        1
010:

Constants:
0: "A well-documented function"
1: f</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
   <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">f</span><span class="p">)</span> <span class="s">"A well-documented function"</span> <span class="mi">5</span><span class="p">)</span>
   <span class="mi">10</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  FALSE-PUSH
002:  ENTER-TAIL-LET       1
004:  CREATE-CLOSURE       4 0  ;; ==&gt; 010
007:  SMALL-INT            5
009:  RETURN
010:  DOCSTRG              0
012:  LOCAL-SET0
013:  SMALL-INT            10
015:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>DOCSTRG</code> seems to have a zero argument because it uses a constant
string, and <code>disassemble</code> does not show values of strings and symbol
names.</p>
</div>
<div class="paragraph">
<p>The <code>FORMALS</code> opcode is similar to <code>DOCSTRG</code>, except that it expects a
list instead of a string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">compiler:keep-formals</span> <span class="no">#t</span><span class="p">)</span>

<span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">a</span> <span class="nv">b</span> <span class="o">.</span> <span class="nv">c</span><span class="p">)</span>
                     <span class="s">"A well-documented function"</span>
                     <span class="p">(</span><span class="nb">*</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">))</span>
                  <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CREATE-CLOSURE       5 -3;; ==&gt; 007
003:  LOCAL-REF2
004:  IN-SINT-MUL2         3
006:  RETURN
007:  FORMALS              0
009:  DOCSTRG              1
011:  DEFINE-SYMBOL        2
013:

Constants:
0: (a b . c)
1: "A well-documented function"
2: f</pre>
</div>
</div>
<div class="sect2">
<h3 id="_creating_closures_and_procedures">10.1. Creating closures and procedures</h3>
<div class="paragraph">
<p>The following opcode creates a closure.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CREATE_CLOSURE</pre>
</div>
</div>
<div class="paragraph">
<p>This opcode fetches two parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the number of instructions ahead that the VM needs to jump to (because
what follows is the code of a closure being created, and it should <em>not</em>
be executed, so the VM wull jump over it)</p>
</li>
<li>
<p>the closure arity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="s">"Hello"</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CREATE-CLOSURE       4 0  ;; ==&gt; 006
003:  CONSTANT             0
005:  RETURN
006:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="nv">x</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CREATE-CLOSURE       5 1  ;; ==&gt; 007
003:  LOCAL-REF0
004:  IN-SINT-MUL2         2
006:  RETURN
007:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
   <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">g</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">)</span> <span class="mi">10</span><span class="p">)</span>
   <span class="nv">g</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  FALSE-PUSH
002:  ENTER-TAIL-LET       1
004:  CREATE-CLOSURE       4 3  ;; ==&gt; 010
007:  SMALL-INT            10
009:  RETURN
010:  LOCAL-SET0
011:  LOCAL-REF0
012:  RETURN</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_procedure_calls">10.2. Procedure calls</h3>
<div class="paragraph">
<p>The following opcodes are used to make procedure calls:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PREPARE-CALL        ( PREP_CALL() in vm.c )
INVOKE
TAIL_INVOKE
GREF-INVOKE
GREF-TAIL-INVOKE
PUSH_GREF_INVOKE
PUSH_GREF_TAIL_INV</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PREPARE-CALL</code> pushes an activation record on the stack.</p>
</li>
<li>
<p><code>INVOKE</code> opcodes call procedures – local or global; in tail position or not.
The ones with the <code>PUSH_</code> prefix also push an argument onto the stack.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are handled in the VM as states in the state machine (they are
labels used in the <code>CASE`s in `vm/.c</code>).</p>
</div>
<div class="paragraph">
<p>In <code>vm.c</code>, all these instructions end up sending the control to the
<code>FUNCALL:</code> label, which will then check what to do depending on the
type of call (<code>tc_instance</code>, <code>tc_closure</code>, <code>tc_next_method</code>, <code>tc_apply</code>,
or some primitive, <code>tc_subr&#8230;&#8203;</code>)</p>
</div>
<div class="paragraph">
<p>The peephole optimizer will combine <code>PUSH</code>, <code>GLOBAL-REF</code> <code>INVOKE</code> instructions,
yielding combined instructions. The following is an excerpt from <code>peephole.stk</code>
where these transformations are documented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="c1">;; [GLOBAL-REF, PUSH] =&gt; GLOBAL-REF-PUSH</span>
<span class="c1">;; [PUSH GLOBAL-REF] =&gt; PUSH-GLOBAL-REF</span>
<span class="c1">;; [PUSH-GLOBAL-REF, INVOKE] =&gt; PUSH-GREF-INVOKE</span>
<span class="c1">;; [PUSH-GLOBAL-REF, TAIL-INVOKE] =&gt; PUSH-GREF-TAIL-INV</span>
<span class="c1">;; [PUSH, PREPARE-CALL] =&gt; PUSH-PREPARE-CALL</span>
<span class="c1">;; [GLOBAL-REF, INVOKE] =&gt; GREF-INVOKE</span>
<span class="c1">;; [GLOBAL-REF, INVOKE] =&gt; GREF-INVOKE</span>
<span class="c1">;; [GLOBAL-REF, TAIL-INVOKE] =&gt; GREF-TAIL-INVOKE</span>
<span class="c1">;; [LOCAL-REFx, PUSH] =&gt; LOCAL-REFx-PUSH</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments to the <code>INVOKE</code>-like instructions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INVOKE</code>: <code>n_args</code> (the procedure address is the first item on the stack, so
it is not passed as argument in the code)</p>
</li>
<li>
<p><code>GREF-INVOKE</code>: <code>proc_addr</code>, <code>n_args</code></p>
</li>
<li>
<p><code>PUSH-GREF-INVOKE</code>: <code>first_arg</code>, <code>proc_addr</code>, <code>n_args</code> (pushes the first and calls
the procedure with <code>n_args</code> arguments form the stack</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nf">f</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  GREF-TAIL-INVOKE     0 0
004:  RETURN</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nf">f</span> <span class="mi">3</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  INT-PUSH             3
003:  GREF-TAIL-INVOKE     0 1
006:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>In the next example, <code>GREF-INVOKE</code> is called with arguments 0
and 0. The <strong>first</strong> value 0 is the address of the procedure in the
stack. The <code>IN-SINT-ADD2</code> procedure is called afterwards to sum 3 with
the return from <code>f</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">f</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  GREF-INVOKE          0 0
004:  IN-SINT-ADD2         3
006:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>In the next example, <code>GREF-INVOKE</code> is called with arguments 0
and 2. The value 0 is the address of the procedure in the
stack; 2 is the number of arguments given in this procedure call.
The <code>IN-SINT-ADD2</code> procedure is called afterwards to sum 5 with
the return from <code>f</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">+</span> <span class="mi">5</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">x</span> <span class="no">#f</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  LOCAL-REF0-PUSH
002:  FALSE-PUSH
003:  GREF-INVOKE          0 2
006:  IN-SINT-ADD2         5
008:  RETURN</pre>
</div>
</div>
<div class="paragraph">
<p>Now the next example shows how <code>INVOKE</code> is used to call a procedure that
is non-global (it is in the local environment).
The <code>INVOKE</code> instruction will use the first value on the stack as the
address of the procedure (it&#8217;s <code>DEEP-LOCAL-REF 256</code>, since <code>f</code> is defined
inside the <code>let</code>). The other two arguments to be popped from the stack are
<code>#f</code> (pushed by the <code>FALSE-PUSH</code> instruction) and the global variable <code>y</code>
(pushed by the instruction <code>GLOBAL-REF-PUSH 0</code>). After <code>INVOKE</code> calls <code>f</code>,
the instruction <code>IN-SINT-ADD2 3</code> will sum <code>3</code> to the result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">f</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="nv">x</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">disassemble</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
     <span class="p">(</span><span class="nb">+</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">y</span> <span class="no">#f</span><span class="p">)))))</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  GLOBAL-REF-PUSH      0
003:  FALSE-PUSH
004:  DEEP-LOCAL-REF       256
006:  INVOKE               2
008:  IN-SINT-ADD2         3
010:  RETURN</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modules">11. Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following opcode enters a given module.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SET_CUR_MOD</pre>
</div>
</div>
<div class="paragraph">
<p>An SCM object of type <code>module</code> must be in the <code>val</code> resgister.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nf">select-module</span> <span class="nv">m</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  PREPARE-CALL
001:  CONSTANT-PUSH        0
003:  GREF-INVOKE          1 1
006:  SET-CUR-MOD
007:

Constants:
0: m
1: find-module</pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, the constants were two symbols: <code>m</code> and
<code>find-module</code>. The <code>find-module</code> procedure, which is called, will leave
module <code>m</code> in the <code>val</code> register, which is then used by <code>SET_CUR_MOD</code>.</p>
</div>
<div class="paragraph">
<p>The following opcode defines a variable in a module.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>DEFINE_SYMBOL</pre>
</div>
</div>
<div class="paragraph">
<p>It will define a variable with name set as symbol fetched after the
opcode, and value in the <code>val</code> register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="k">define</span> <span class="nv">a</span> <span class="s">"abc"</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  CONSTANT             0
002:  DEFINE-SYMBOL        1
004:

Constants:
0: "abc"
1: a</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="k">define</span> <span class="nv">a</span> <span class="no">#f</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>000:  IM-FALSE
001:  DEFINE-SYMBOL        0
003:

Constants:
0: a</pre>
</div>
</div>
<div class="paragraph">
<p>There is an instruction for returning the value of a symbol in the
<code>SCHEME</code> module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nf">%in-scheme</span> <span class="ss">'a</span><span class="p">)</span> <span class="no">#t</span><span class="p">)</span>

<span class="mi">000</span><span class="nv">:</span>  <span class="nv">CONSTANT</span>             <span class="mi">0</span>
<span class="mi">002</span><span class="nv">:</span>  <span class="nv">INSCHEME</span>
<span class="mi">003</span><span class="nv">:</span>

<span class="nv">Constants:</span>
<span class="mi">0</span><span class="nv">:</span> <span class="nv">a</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vm_c">12. <code>vm.c</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>An important observation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>apply</code> : there <strong>is</strong> a <code>DEFINE_PRIMITIVE("apply", &#8230;&#8203;)</code>, but it is <strong>not</strong>
used. It is necessary just so there is a primitive of the type <code>tc_apply</code>.
When the VM finds a primitive of this kind, it&#8217;ll treat it differently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some basic functions in the VM:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>push(v)</code>: pushes <code>v</code> on the stack (the stack pointer is decreased)</p>
</li>
<li>
<p><code>pop()</code>: pops a value from the stack (the stack pointer is increased)</p>
</li>
<li>
<p><code>fetch_next()</code>  fetches the <strong>next</strong> opcode, increasing the PC</p>
</li>
<li>
<p><code>fetch_const()</code> fetches the <strong>next</strong> opcode and uses it as index for a constant</p>
</li>
<li>
<p><code>look_const()</code> looks at the <strong>current</strong> opcode and uses it as index for a constant</p>
</li>
<li>
<p><code>fetch_global()</code> fetches the <strong>next</strong> opcode and uses it as index for a global variable</p>
</li>
<li>
<p><code>add_global(ref)</code> adds <code>ref</code> to the list of global variables, and returns its index.
If it was already there, the old index is returned. If it was not, a place is allocated
for it, and the new index is returned.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Already covered before:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SCM STk_C_apply(SCM func, int nargs, &#8230;&#8203;)</code>: applies <code>func</code>, with <code>nargs</code> arguments</p>
</li>
<li>
<p><code>SCM STk_C_apply_list(SCM func, SCM l)</code>: applies <code>func</code>, with a list of arguments</p>
</li>
<li>
<p><code>SCM STk_n_values(int n, &#8230;&#8203;)</code>: prepares <code>n</code> values in the VM (for the next instruction), and
returns a pointer to the <code>vm&#8594;val</code> register</p>
</li>
<li>
<p><code>SCM STk_values2vector(SCM obj, SCM vect)</code>: turns a <code>values</code> object into an array with the values</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_the_global_lock">12.1. The global lock</h3>
<div class="paragraph">
<p>There is one global mutex lock for STklos, called <code>global_code_lock</code>, declared in <code>vm.c</code>:</p>
</div>
<div class="paragraph">
<p><code>MUT_DECL(global_code_lock);  /* Lock to permit code patching */</code></p>
</div>
<div class="paragraph">
<p>As per the comment, its purpose is to discipline access to the instructions of
the running program.  This lock is used when patching code for optimizing
further global variables accesses (as explained before). This is necessary since
STklos can use several threads. Note that each Scheme thread use its own
VM, but the code and the global variables are shared among all the threads.</p>
</div>
<div class="paragraph">
<p>Three macros are used to control the global lock (a mutex):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>LOCK_AND_RESTART</code> will acquire the lock, and decrease the program counter.
It will also set a flag that signals to the running VM that the lock has been
acquired by this thread, and then call <code>NEXT</code>.  The name &#8220;AND_RESTART&#8221;
reflects the fact that it decreases the PC and calls <code>NEXT</code> (for the next
instruction)&#8201;&#8212;&#8201;so the effect is to start again operating on this instruction,
but this time with the lock.</p>
</li>
<li>
<p><code>RELEASE_LOCK</code> will release the lock, regardless of the thread having it or not. The flag indicating ownership by this thread is cleared.</p>
</li>
<li>
<p><code>RELEASE_POSSIBLE_LOCK</code> will release the lock <strong>if</strong> this thread has it.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_run_vmvm_thread_vm">12.2. <code>run_vm(vm_thread *vm)</code></h3>
<div class="paragraph">
<p>After some initial setup, this function will operate as a state machine.
Its basic structure is shown below.</p>
</div>
<div class="paragraph">
<p>The <code>CASE</code> symbol is defined differently, depending on the system, but <code>CASE(x)</code> semantically
simialar to <code>case x:</code> (if computed GOTOs are better, then it&#8217;s defined as a label instead&#8201;&#8212;&#8201;see its definition in <code>vm.c</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">for</span> <span class="p">(</span> <span class="c1">; ; ) {</span>

  <span class="nv">byteop</span> <span class="nv">=</span> <span class="nv">fetch_next</span><span class="p">()</span><span class="c1">;  /* next instruction */</span>

  <span class="nv">switch</span> <span class="p">(</span><span class="nf">byteop</span><span class="p">)</span> <span class="err">{</span>

    <span class="nv">CASE</span><span class="p">(</span><span class="nf">NOP</span><span class="p">)</span> <span class="err">{</span> <span class="nv">NEXT</span><span class="c1">; }</span>
    <span class="nv">CASE</span><span class="p">(</span><span class="nf">IM_FALSE</span><span class="p">)</span>  <span class="err">{</span> <span class="nv">vm-&gt;val</span> <span class="nv">=</span> <span class="nv">STk_false</span><span class="c1">;       NEXT1;}</span>
    <span class="nv">CASE</span><span class="p">(</span><span class="nf">IM_TRUE</span><span class="p">)</span>   <span class="err">{</span> <span class="nv">vm-&gt;val</span> <span class="nv">=</span> <span class="nv">STk_true</span><span class="c1">;        NEXT1;}</span>

    <span class="o">...</span>

    <span class="nv">CASE</span><span class="p">(</span><span class="nf">PUSH_GLOBAL_REF</span><span class="p">)</span>
    <span class="nv">CASE</span><span class="p">(</span><span class="nf">GLOBAL_REF</span><span class="p">)</span> <span class="err">{</span>
      <span class="o">...</span>
    <span class="err">}</span>

    <span class="o">...</span> <span class="p">(</span><span class="nf">several</span> <span class="nv">cases</span> <span class="nv">here</span><span class="p">)</span>

    <span class="nv">FUNCALL:</span>  <span class="nv">/*</span> <span class="nv">we</span> <span class="s">"goto"</span> <span class="nv">here</span> <span class="nv">for</span> <span class="nv">procedure</span> <span class="nv">invoking</span> <span class="nv">from</span>
                 <span class="nv">other</span> <span class="nv">places</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">VM</span> <span class="nv">*/</span>
    <span class="err">{</span>
      <span class="o">...</span>
    <span class="err">}</span>
    <span class="nv">STk_panic</span><span class="p">(</span><span class="s">"abnormal exit from the VM"</span><span class="p">)</span><span class="c1">; /* went through the switch(byteop) */</span>
  <span class="err">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_continuations">13. Continuations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are undocumented primitives in <code>vm.c</code> that can be used to capture
and restore continuations. They are listed here with their undocumented Scheme
counterparts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_make_continuation()</code>&#8201;&#8212;&#8201;<code>(%make-continuation)</code></p>
</li>
<li>
<p><code>STk_restore_cont(SCM cont, SCM value)</code>&#8201;&#8212;&#8201;<code>(%restore-continuation cont value)</code></p>
</li>
<li>
<p><code>STk_continuationp(SCM obj)</code>&#8201;&#8212;&#8201;<code>(%continuation? obj)</code></p>
</li>
<li>
<p><code>STk_fresh_continuationp(SCM obj)</code>&#8201;&#8212;&#8201;<code>(%fresh-continuation? obj)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Continuation is a native type (<code>tc_continuation</code>). A continuation object (defined
in <code>vm.h</code>) contains pointers to the C stack, the Scheme stack and several other
data.</p>
</div>
<div class="paragraph">
<p>STklos saves both the C and the Scheme stack when capturing
continuations. For that to work, we need to be able to tell where the
C stack begins and where the top is (the precise C pointers to those
places).</p>
</div>
<div class="paragraph">
<p>The C function that retrieves the address of the current top of the
stack is quite simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">void</span> <span class="nf">STk_get_stack_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is called when initializing the current thread, and also when
capturing and saving continuations.</p>
</div>
<div class="sect3">
<h4 id="_capturing_a_continuation">13.1. Capturing a continuation</h4>
<div class="paragraph">
<p><code>%make-continuation</code> is the primitive that captures the current
continuation.</p>
</div>
<div class="paragraph">
<p>It basically:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Determines the size of the C stack and the start address;</p>
</li>
<li>
<p>Determines the size of the Scheme stack;</p>
</li>
<li>
<p>Allocates a object of type <code>struct continuation_obj</code>, but whose size
is that of the continuation structure <strong>plus</strong> the size of the two stacks;</p>
</li>
<li>
<p>Copies the Scheme and C stacks into the continuation object;</p>
</li>
<li>
<p>Calls <code>patch_environment(vm)</code>. This will clone the environments
down through the activation records (we cannot just copy the stack; the
values must be copied to the ones at the time the continuation was captured);</p>
</li>
<li>
<p>Copies the VM registers into the continuation;</p>
</li>
<li>
<p>Allocates and copy the Scheme stack and the C stack;</p>
</li>
<li>
<p>Marks the continuation as fresh;</p>
</li>
<li>
<p>Uses the usual <code>setjmp</code> method to either return the continuation
object (if it&#8217;s the first time it is used) or return the continuation
value (if it is getting back after being caputred).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_restoring_a_continuation">13.2. Restoring a continuation</h4>
<div class="paragraph">
<p><code>restore_cont_jump</code> is the final step when restoring a continuation.
It receives two parameters:
- parameter <code>k</code> is used to get the beginning and end of the C stack to
  be restored;
- parameter <code>addr</code> is the current top of the C stack;</p>
</div>
<div class="paragraph">
<p>Inside the function,
- <code>vm</code> (obtained inside the function) is THIS thread;
- <code>vm&#8594;start_stack</code> is the beginning of the stack (in this thread).</p>
</div>
<div class="paragraph">
<p>This is what this C function does:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Calculate the distance from beginning to the top, in order to be
sure that there is enough room (if the current stack is shorter
than the old, we cannot just copy over the top!);</p>
</li>
<li>
<p>If there&#8217;s not enough space, call ourselves recursively. Sounds
strange, but&#8201;&#8212;&#8201;with each recursive call, we allocate 1024 bytes
(see at the beginning of the function&#8201;&#8212;&#8201;the declaration
<code>char unused_buf[1024];</code> serves this purpose only!);</p>
</li>
<li>
<p><code>memcpy</code> from the beginning to the (new) top;</p>
</li>
<li>
<p><code>longjmp</code> to the saved state, but this time return 1.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>%restore-continuation</code> is called when we do <code>(k val)</code> inside a
<code>(call/cc (lambda (k) &#8230;&#8203;))</code>.</p>
</div>
<div class="paragraph">
<p>This C function (and Scheme primitive) basically:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copies the continuation information into the VM registers;</p>
</li>
<li>
<p>Copies <code>value</code> into VM&#8217;s <code>val</code> register (because the value is not
part of the continuation, it was passed now to
<code>%restore-continuation</code>);</p>
</li>
<li>
<p>Sets <code>fresh</code> to <code>0</code> in the continuation (marks it as already
restored);</p>
</li>
<li>
<p>Copies the Scheme stack from the continuation, overriding the
current Scheme stack (no need to check if it fits, since the Scheme
stack has a fixed size and has been allocated already);</p>
</li>
<li>
<p>Gets the address of the current top of the C stack. This is done by
calling <code>STk_get_stack_pointer(&amp;addr)</code>;</p>
</li>
<li>
<p>Calls <code>restore_cont_jump(k, addr)</code>, where <code>k</code> is the continuation
and <code>addr</code> is the top of the C stack.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_verifying_the_vm_configuration">14. Verifying the VM configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The primitive <code>%vm-config</code> returns an association list describing the
compile-time configuration of the VM. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>stklos&gt; (%vm-config )
(#:computed-goto #t #:debug-vm #f #:stat-vm #t)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>#:computed-goto</code>: was <code>vm.c</code> compiled using computed <code>goto</code>?</p>
</li>
<li>
<p><code>#:debug-vm</code>: does this STklos binary have debugging enabled?</p>
</li>
<li>
<p><code>#:stat-vm</code>: was the VM compiled with code for statistics-collecting?</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collecting_statistics">15. Collecting statistics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The code in <code>vm.c</code> can optionally be compiled to collect statistics.
If the symbol <code>STAT_VM</code> is defined during compilation, then the statistics-collecting
code will be enabled. You can enable it, for example, by configuring STklos as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>./configure CFLAGS="-DSTAT_VM" ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the code has been compiled as this, the VM will, at the end of
each iteration, check the instruction that was just executed and
update:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of times that this instruction was executed</p>
</li>
<li>
<p>The number of times that this instruction was executed after the
previous one (so it&#8217;s possible to tell what pairs of instructions
are more common)</p>
</li>
<li>
<p>The time taken to execute this instruction</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is done in the <code>tick()</code> C function (which is compiled
conditionally on <code>STAT_VM</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">tick</span><span class="p">(</span><span class="n">STk_instr</span> <span class="n">b</span><span class="p">,</span> <span class="n">STk_instr</span> <span class="o">*</span><span class="n">previous_op</span><span class="p">,</span> <span class="kt">clock_t</span> <span class="o">*</span><span class="n">previous_time</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">clock_t</span> <span class="n">current_time</span><span class="p">;</span>
  <span class="n">current_time</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
  <span class="n">couple_instr</span><span class="p">[</span><span class="o">*</span><span class="n">previous_op</span><span class="p">][</span><span class="n">b</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="n">cpt_inst</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
  <span class="o">*</span><span class="n">previous_op</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">previous_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">time_inst</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)(</span><span class="n">current_time</span> <span class="o">-</span> <span class="o">*</span><span class="n">previous_time</span><span class="p">))</span> <span class="o">/</span> <span class="n">CLOCKS_PER_SEC</span><span class="p">;</span>
  <span class="o">*</span><span class="n">previous_time</span> <span class="o">=</span> <span class="n">clock</span><span class="p">();</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Three Scheme primitives are then available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(%vm-dump-stats fname format)</code> will dump the statistics to a file whose
name is <code>fname</code>.  The file will be opened using plain <code>fopen</code>.  When the
<code>format</code> argument is the keyword <code>:csv</code>, then the output is in CSV format;
otherwise, there will be one single S-expression in the file, readable from
Scheme. This S-expression is an alist, documented in the file itself (see
below).</p>
</li>
<li>
<p><code>(%vm-reset-stats)</code> will reset all counters.</p>
</li>
<li>
<p><code>(%vm-collect-stats . val)</code> is a parameter object. When called without
value, it returns if statistics are collected or not. If the value <code>val</code>
is determined, then statistics</p>
<div class="ulist">
<ul>
<li>
<p>will start being collected, if <code>val</code> is <code>#t</code>;</p>
</li>
<li>
<p>will not be collected anymore if <code>val</code> is <code>#f</code>.</p>
<div class="literalblock">
<div class="content">
<pre> Collecting statistics is off by default, especially because compiling STklos
is very slow with statistics gathering. It should be turned on before profiling.</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The status of "collecting" or "not collecting" reflects what happens internaly in the
statistics gathering code, <strong>when it is compiled in</strong>. If STklos was compiled without
<code>STAT_VM</code>, then those procedures are just not available at all.</p>
</div>
<div class="paragraph">
<p>The documentation for the Scheme format for the dumped instructions is
shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="c1">;; STklos VM statistics. It can be read in Scheme, and it represents one single</span>
<span class="c1">;; object: an alist with the names of instructions, and each CDR is a list</span>
<span class="c1">;; containing:</span>
<span class="c1">;;</span>
<span class="c1">;; * count (the number of times this instruction was executed)</span>
<span class="c1">;; * time (the total time the program spent on this instruction)</span>
<span class="c1">;; * avg time (the average number of time spent on each execution of this</span>
<span class="c1">;;   instruction)</span>
<span class="c1">;; * an alist containing, for each OTHER instruction, the number of times they</span>
<span class="c1">;;   appeared together in the code.</span>
<span class="c1">;;</span>
<span class="c1">;; ( (INS1 count1 time1 avgtime1 ( (INS1 . count1) (INS2 . count2) ... (INSn  . countn)))</span>
<span class="c1">;;   (INS2 count2 time2 avgtime2 ( (INS1 . count1) (INS2 . count2) ... (INSn  . countn)))</span>
<span class="c1">;;   ...</span>
<span class="c1">;;   (INSn countn timen avgtimen ( (INS1 . count1) (INS2 . count2) ... (INSn  . countn))) )</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The C code for printing the instructions is in the functions
<code>dump_couple_instr_csv</code> and <code>dump_couple_instr_scm</code>.</p>
</div>
<div class="paragraph">
<p>Note that the <code>%vm-config</code> can be used to determine if the system has been
compiled with the profiling code. As said before, this primitive returns a
property list and <code>#:stat-vm</code> can be used here.</p>
</div>
<div class="paragraph">
<p>To profile some specific code there is the <code>%with-profile-data</code> macro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">%with-profile-data</span> <span class="s">"file-name.csv"</span> <span class="nv">:csv</span>
  <span class="p">(</span><span class="nb">display</span> <span class="ss">'a</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">values</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will expand to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">receive</span>
  <span class="nv">result-4</span>
  <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nf">%vm-reset-stats</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">display</span> <span class="ss">'a</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">values</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
         <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nf">%vm-dump-stats</span> <span class="s">"file-name.csv"</span> <span class="o">#</span><span class="nv">:csv</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">apply</span> <span class="nv">values</span> <span class="nv">result-4</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the macro will return the same values that the code would, and will profile only
that part of the code.</p>
</div>
</div>
</div>
</div>
</body>
</html>