<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Jeronimo Pellegrini">
<title>Hacking STklos</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cm {
  color: #75715e;
  font-style: italic;
}
pre.rouge .c1 {
  color: #75715e;
  font-style: italic;
}
pre.rouge .cp {
  color: #75715e;
  font-weight: bold;
}
pre.rouge .cs {
  color: #75715e;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .err {
  color: #960050;
  background-color: #1e0010;
}
pre.rouge .gi {
  color: #ffffff;
  background-color: #324932;
}
pre.rouge .gd {
  color: #ffffff;
  background-color: #493131;
}
pre.rouge .ge {
  font-style: italic;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .k, pre.rouge .kv {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kc {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kd {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kp {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kr {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kt {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .kn {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .ow {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .o {
  color: #f92672;
  font-weight: bold;
}
pre.rouge .mf {
  color: #ae81ff;
}
pre.rouge .mh {
  color: #ae81ff;
}
pre.rouge .il {
  color: #ae81ff;
}
pre.rouge .mi {
  color: #ae81ff;
}
pre.rouge .mo {
  color: #ae81ff;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #ae81ff;
}
pre.rouge .se {
  color: #ae81ff;
}
pre.rouge .sa {
  color: #66d9ef;
  font-weight: bold;
}
pre.rouge .sb {
  color: #e6db74;
}
pre.rouge .sc {
  color: #e6db74;
}
pre.rouge .sd {
  color: #e6db74;
}
pre.rouge .s2 {
  color: #e6db74;
}
pre.rouge .sh {
  color: #e6db74;
}
pre.rouge .si {
  color: #e6db74;
}
pre.rouge .sx {
  color: #e6db74;
}
pre.rouge .sr {
  color: #e6db74;
}
pre.rouge .s1 {
  color: #e6db74;
}
pre.rouge .ss {
  color: #e6db74;
}
pre.rouge .s, pre.rouge .dl {
  color: #e6db74;
}
pre.rouge .na {
  color: #a6e22e;
}
pre.rouge .nc {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nd {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .ne {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #a6e22e;
  font-weight: bold;
}
pre.rouge .no {
  color: #66d9ef;
}
pre.rouge .bp {
  color: #f8f8f2;
}
pre.rouge .nb {
  color: #f8f8f2;
}
pre.rouge .ni {
  color: #f8f8f2;
}
pre.rouge .nn {
  color: #f8f8f2;
}
pre.rouge .vc {
  color: #f8f8f2;
}
pre.rouge .vg {
  color: #f8f8f2;
}
pre.rouge .vi {
  color: #f8f8f2;
}
pre.rouge .nv, pre.rouge .vm {
  color: #f8f8f2;
}
pre.rouge .w {
  color: #f8f8f2;
}
pre.rouge .nl {
  color: #f8f8f2;
  font-weight: bold;
}
pre.rouge .nt {
  color: #f92672;
}
pre.rouge {
  color: #f8f8f2;
  background-color: #49483e;
}
</style>
<style>
  /* Customize default CSS */
  .sidebarblock { margin-top: -1em; }
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Hacking STklos</h1>
<div class="details">
<span id="author" class="author">Jeronimo Pellegrini</span><br>
<span id="email" class="email"><a href="mailto:j_p@aleph0.info">j_p@aleph0.info</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_basic_editor_configuration">1. Basic editor configuration</a></li>
<li><a href="#_directories">2. Directories</a></li>
<li><a href="#_basic_debugging">3. Basic debugging</a>
<ul class="sectlevel2">
<li><a href="#_stk_debug">3.1. STK_DEBUG</a></li>
<li><a href="#_other_debugging_primitives_in_scheme">3.2. Other debugging primitives in Scheme</a></li>
<li><a href="#_c_debugging">3.3. C debugging</a></li>
</ul>
</li>
<li><a href="#_stklos_initialization">4. STklos initialization</a></li>
<li><a href="#_adding_simple_modules_and_srfis">5. Adding simple modules and SRFIs</a>
<ul class="sectlevel2">
<li><a href="#_adding_modules">5.1. Adding modules</a></li>
<li><a href="#_module_placement_in_the_tree">5.2. Module placement in the tree</a></li>
<li><a href="#_adding_srfis">5.3. Adding SRFIs</a></li>
<li><a href="#_mixed_srfis_scheme_and_c">5.4. Mixed SRFIs (Scheme and C)</a></li>
<li><a href="#_documentation">5.5. Documentation</a></li>
</ul>
</li>
<li><a href="#_writing_primitives_in_c">6. Writing primitives in C</a>
<ul class="sectlevel2">
<li><a href="#_calling_scheme_primitives">6.1. Calling Scheme primitives</a></li>
<li><a href="#_returning_multiple_values">6.2. Returning multiple values</a></li>
<li><a href="#_using_multiple_returned_values">6.3. Using multiple returned values</a></li>
<li><a href="#_errors">6.4. Errors</a></li>
<li><a href="#_unboxed_types">6.5. Unboxed types</a></li>
<li><a href="#_boxed_types">6.6. Boxed types</a></li>
<li><a href="#_dynamically_loadable_modules">6.7. Dynamically loadable modules</a></li>
<li><a href="#_input_and_output_from_c">6.8. Input and output from C</a></li>
<li><a href="#_creating_new_types">6.9. Creating new types</a></li>
</ul>
</li>
<li><a href="#_continuations">7. Continuations</a></li>
<li><a href="#_the_virtual_machine">8. The virtual machine</a></li>
<li><a href="#_compiler_and_optimizations">9. Compiler and optimizations</a>
<ul class="sectlevel2">
<li><a href="#_the_compiler">9.1. The compiler</a></li>
<li><a href="#_peephole_optimizer">9.2. Peephole optimizer</a></li>
<li><a href="#_source_rewriter">9.3. Source rewriter</a></li>
</ul>
</li>
<li><a href="#_garbage_collection">10. Garbage collection</a></li>
<li><a href="#_c_variables_for_conditional_compilation">11. C variables for conditional compilation</a>
<ul class="sectlevel2">
<li><a href="#_detecting_libffi_libgmp_dynamic_loading">11.1. Detecting libffi, libgmp, dynamic loading</a></li>
<li><a href="#_statistics_gathering">11.2. Statistics gathering</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This is a quick guide to STklos hacking. It’s not detailed, so the
document doesn’t become huge, and also because after understanding the
basics, hacking STklos should not be difficult.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_editor_configuration">1. Basic editor configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a <code>.editorconfig</code> file in STklos' root folder, which
describes the style to be used, and which is automatically used when
editorconfig is configured ([editorconfig](<a href="https://editorconfig.org/" class="bare">https://editorconfig.org/</a>)
helps maintain consistentcoding styles for multiple developers working
on the same project across various editors and IDEs).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_directories">2. Directories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The subdirectories in the STklos source tree are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>doc</code> – documentation, written mostly in asciidoctor</p>
</li>
<li>
<p><code>etc</code> – various sample files for specific needs</p>
</li>
<li>
<p><code>examples</code> – examples (oh, who could tell?)</p>
</li>
<li>
<p><code>ffi</code> – <code>libffi</code> (a local copy)</p>
</li>
<li>
<p><code>gc</code> – the Boehm-Demers-Weiser garbage collector, libgc (a local copy)</p>
</li>
<li>
<p><code>gmp</code> – a slow compatible GNU MP</p>
</li>
<li>
<p><code>lib</code> – Scheme files, including from basic things like the boot
program up to high-level things like modules implementing libraries and
SRFIs</p>
</li>
<li>
<p><code>pcre2</code> – <code>libpcre</code> (a local copy)</p>
</li>
<li>
<p><code>pkgman</code> – the package manager</p>
</li>
<li>
<p><code>src</code> – the STklos core, written in C</p>
</li>
<li>
<p><code>tests</code> – the tests, of course!</p>
</li>
<li>
<p><code>utils</code> – utilities and wrappers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The "local copies" of <code>libffi</code>, <code>libgc</code> and <code>libpcre</code>, as well as the mini-GMP
in <code>gmp/</code> are compiled when there&#8217;s no version of those available in the system,
or when you force their use in the configure script with <code>--with-provided-gc</code>,
<code>--with-gmp-light</code> and so on.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_debugging">3. Basic debugging</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_stk_debug">3.1. STK_DEBUG</h3>
<div class="paragraph">
<p>STklos has conditionally-compiled debugging code, which is enabled when
the <code>STK_DEBUG</code> variable is visible to the C compiler. To enable a
debug-enabled binary of STklos, configure it passing <code>CFLAGS="-DSTK_DEBUG"</code>
to the configure script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>./configure CFLAGS="-DSTK_DEBUG"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will enable:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[misc.c]</code>: <code>(%%debug)</code> which toggles debugging on and off.</p>
</li>
<li>
<p><code>[misc.c]</code>: <code>(%c-backtrace)</code>, which produces a backtrace of C function calls.</p>
</li>
<li>
<p><code>[misc.c]</code>: <code>(%test proc)</code>, which applies <code>proc</code> without arguments.</p>
</li>
<li>
<p><code>[misc.c]</code>: <code>(%vm &#8230;&#8203;)</code>, which you can customize in <code>src/vm.c</code> to your needs.</p>
</li>
<li>
<p><code>[src/utf8.c]</code>: <code>(%char-utf8-encoding c)</code>, which shows how the character <code>c</code> is
encoded in UTF8.</p>
</li>
<li>
<p><code>[`src/utf8.c]</code>: <code>(%dump-string s)</code>, which shows the bytes in the internal representation of
the string <code>s</code>.</p>
</li>
<li>
<p><code>[src/promise.c]</code>: <code>(%promise-value p)</code>, which returns the value of promise <code>p</code>.
When not yet forced, the value will be a procedure, which you can then call. But
calling <code>%promise-value p</code> does <strong>not</strong> force <code>p</code>, and does not interfere with
the rest of the program.</p>
</li>
<li>
<p><code>[src/promise.c]</code>: <code>(%promise-value-set! p v)</code>, which sets the value of promise
<code>p</code> to <code>v</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Clearly, you can add other primitives useful for debugging guarded by</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#ifdef STK_DEBUG
</span><span class="p">...</span>
<span class="cp">#endif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>as necessary.</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_debugging_primitives_in_scheme">3.2. Other debugging primitives in Scheme</h3>
<div class="paragraph">
<p>Even without <code>STK_DEBUG</code>, you can use in your Scheme code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(%vm-backtrace)</code> to obtain a trace of Scheme procedure calls</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_c_debugging">3.3. C debugging</h3>
<div class="paragraph">
<p>When copiling the C part of STklos, it may be interesting to compile
with <code>-g -O0 -Wall</code> also:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>./configure CFLAGS="-DSTK_DEBUG -g -O0 -Wall"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And to use GCC&#8217;s static analyzer (with GCC version 11 or later),</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>./configure CFLAGS="-DSTK_DEBUG -g -O0 -Wall -fanalyzer"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To debug STklos, you can use gdb:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>gdb -q src/stklos</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stklos_initialization">4. STklos initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>main</code> is in <code>src/stklos.c</code>, where command line options are parsed and
the scheme interpreter is started:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_init_library</code> – performs library initialization. This is done in
<code>src/lib.c</code>, which is a very simple file that just calls several
initialization functions. Those functions are defined in different files
under <code>src/</code>;</p>
</li>
<li>
<p><code>build_scheme_args</code> – collects the command line options in the
variable <code><strong>%system-state-plist</strong></code>;</p>
</li>
<li>
<p><code>STk_load_boot</code> – loads the boot file (if one is to be loaded);</p>
</li>
<li>
<p><code>STk_boot_from_C</code> – actually boots the Scheme interpreter. This
function is defined in <code>src/vm.c</code>, where the STklos virtual machine code
is.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to include Scheme code for execution during STklos startup,
edit <code>lib/boot.stk</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_simple_modules_and_srfis">5. Adding simple modules and SRFIs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_adding_modules">5.1. Adding modules</h3>
<div class="ulist">
<ul>
<li>
<p>add your <code>fantastic-module.stk</code> to <code>lib/SUBDIR</code>, where <code>SUBDIR</code>
could be <code>scheme</code>, <code>srfi</code> or <code>stklos</code> (see nect subsection)</p>
</li>
<li>
<p>include <code>fantastic-module.stk</code> and <code>fantastic-module.ostk</code> in the
variables <code>SRC_STK</code> and <code>scheme_OBJS</code>, in <code>lib/Makefile.am</code></p>
</li>
<li>
<p>Tests reside in the <code>tests</code> directory. Create a new file in <code>tests</code>
directory and include it in the list of loaded files in <code>do-test.stk</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_module_placement_in_the_tree">5.2. Module placement in the tree</h3>
<div class="ulist">
<ul>
<li>
<p>STklos modules go into <code>lib/stklos</code></p>
</li>
<li>
<p>Scheme (R7RS small or large) libraries go into <code>lib/scheme</code></p>
</li>
<li>
<p>SRFIs go into <code>lib/srfi</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_adding_srfis">5.3. Adding SRFIs</h3>
<div class="paragraph">
<p>In order to add SRFI 9999 to STklos,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add your <code>9999.stk</code> to <code>lib/srfi</code></p>
</li>
<li>
<p>include <code>9999.stk</code> and <code>9999.ostk</code> in the variables <code>SRC_STK</code> and
<code>SRC_OSTK</code>, in <code>lib/srfi/Makefile.am</code></p>
</li>
<li>
<p>Add a line describing it in <code>lib/srfis.stk</code> (the format is described
in the file itself).</p>
</li>
<li>
<p>Tests reside in the <code>tests</code> directory. Add the tests in a file
<code>tests/srfis/9999.stk</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For new SRFIs, adding its description in <code>lib/srfis.stk</code> suffices to
update</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>SUPPORTED-SRFIS</code> in the main directory</p>
</li>
<li>
<p>launch the tests you added in <code>tests/srfis</code> directory, and</p>
</li>
<li>
<p>add an automatically generated documentation for this SRFI</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_mixed_srfis_scheme_and_c">5.4. Mixed SRFIs (Scheme and C)</h3>
<div class="paragraph">
<p>To add a mixed SRFI 8888,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write a <code>8888.c</code> file and put it in <code>lib/srfi</code></p>
</li>
<li>
<p>Write a <code>8888.stk</code> Scheme file and also put it in <code>lib/srfi</code></p>
</li>
<li>
<p>Add your mixed SRFI to <code>lib/srfi/Makefile.am</code>, in the section <code>`SRFIs
written in C and Scheme'' (variables `SRC_C</code>, <code>SRC_C_STK</code>, and
<code>SRC_SHOBJ</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_content_of_the_scheme_file">5.4.1. Content of the Scheme file</h4>
<div class="paragraph">
<p>The Scheme file will be compiled as a byte-code stream embedded in C.
Here, the compiled file will be called <code>$DIR/srfi-170-incl.c</code>. It is
built by the <code>utils/tmpcomp</code> script with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="sh">../../utils/tmpcomp <span class="nt">-o</span> srfi-170-incl.c <span class="nv">$DIR</span>/srfi-170.stk</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: when the destination file ends with a <code>.c</code> suffix, the <code>tmpcomp</code>
command produces a C file instead of a byte-code file.</p>
</div>
<div class="paragraph">
<p>You don’t have to pay attention to any particular point in the writing
of this file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_content_of_the_c_file">5.4.2. Content of the C file</h4>
<div class="paragraph">
<p>The C file must follow the conventions of dynamically loadable code as
shown in the example in the <code>/etc</code> directory.</p>
</div>
<div class="paragraph">
<p>In this C file, to use the previously compiled Scheme code, you have to
(using SRFI 170 as an example):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>include the file <code>170-incl.c</code> at the top of your C file</p>
</li>
<li>
<p>add a call to execute the Scheme code just before the
<code>MODULE_ENTRY_END</code> directive. This is done with the following
invocation:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c">    <span class="n">STk_execute_C_bytecode</span><span class="p">(</span><span class="n">__module_consts</span><span class="p">,</span> <span class="n">__module_code</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a directive <code>DEFINE_MODULE_INFO</code> at the end of the file. It
permits to access some information of the module (STklos version used to
compile the module, exported symbols, …). For now, this information is
not used, but omitting to add this directive will probably lead to a
compiler warning about an unresolved reference.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As one more example, SRFI 25 has, at the end of the C file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">MODULE_ENTRY_START</span><span class="p">(</span><span class="s">"srfi/25"</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">SCM</span> <span class="n">module</span> <span class="o">=</span>  <span class="n">STk_create_module</span><span class="p">(</span><span class="n">STk_intern</span><span class="p">(</span><span class="s">"srfi/25"</span><span class="p">));</span>
  <span class="n">STk_export_all_symbols</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>

  <span class="n">ADD_PRIMITIVE_IN_MODULE</span><span class="p">(...);</span>
  <span class="p">...</span>
  <span class="p">...</span>

  <span class="cm">/* Execute Scheme code */</span>
  <span class="n">STk_execute_C_bytecode</span><span class="p">(</span><span class="n">__module_consts</span><span class="p">,</span> <span class="n">__module_code</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">MODULE_ENTRY_END</span>

<span class="n">DEFINE_MODULE_INFO</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See SRFI-25, SRFI-27 and SRFI-170 as a reference.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_documentation">5.5. Documentation</h3>
<div class="sect3">
<h4 id="_documenting_srfis_in_srfi_adoc">5.5.1. Documenting SRFIs in <code>srfi.adoc</code></h4>
<div class="paragraph">
<p>General documentation is automatically generated for SRFIs. If you need
to give a precision specific to a given SRFI, add it to the end of the
<code>doc/refman/srfi.adoc</code> file using the <code>gen-srfi-documentation</code> function.</p>
</div>
<div class="paragraph">
<p>Note that the documentation is written in Skribe tool which is no more
maintained. Consequently, the documentation will not be generated. The
HTML and PDF documentation is rebuilt from time to time by @egallesio.</p>
</div>
</div>
<div class="sect3">
<h4 id="_documenting_primitives_written_in_c">5.5.2. Documenting primitives written in C</h4>
<div class="paragraph">
<p>Before <code>DEFINE_PRIMITIVE</code>, add a comment similar to the others you see
in the C files. An example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/*
&lt;doc EXT bignum?
 * (bignum? x)
 *
 * This predicates returns |#t| if |x| is an integer number too large to be
 * represented with a native integer.
 * @lisp
 * (bignum? (expt 2 300))     =&gt; |#t|   (very likely)
 * (bignum? 12)               =&gt; |#f|
 * (bignum? "no")             =&gt; |#f|
 * @end lisp
doc&gt;
*/</span>
<span class="n">DEFINE_PRIMITIVE</span><span class="p">(</span><span class="s">"bignum?"</span><span class="p">,</span> <span class="n">bignump</span><span class="p">,</span> <span class="n">subr1</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">x</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">MAKE_BOOLEAN</span><span class="p">(</span><span class="n">BIGNUMP</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Pay attention to the parts of this comment: it begins with the primitive
name, then there’s an explanation, then examples in Scheme. Wrap
symbols/identifiers in <code>|.|</code>; use <code>@lisp</code> and <code>@end lisp@</code> to show an
example of usage.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_primitives_in_c">6. Writing primitives in C</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Use the macro <code>DEFINE_PRIMITIVE</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">DEFINE_PRIMITIVE</span><span class="p">(</span><span class="s">"fixnum?"</span><span class="p">,</span> <span class="n">fixnump</span><span class="p">,</span> <span class="n">subr1</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">obj</span><span class="p">))</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">MAKE_BOOLEAN</span><span class="p">(</span><span class="n">INTP</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments for this example are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Scheme name</p>
</li>
<li>
<p>C function name (its full name will have the string ```STk_&#8217;'
prepended to it)</p>
</li>
<li>
<p>the type of primitive (in this case, it is a subroutine with one
parameter – ```subr1&#8217;'</p>
</li>
<li>
<p>the arguents, surrounded by parentheses. In this case there is only
one argument, <code>`obj&#8217;', and its type is </code>`SCM&#8217;' (which is the type of
all Scheme objects in STklos).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then add it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">ADD_PRIMITIVE</span><span class="p">(</span><span class="n">fixnump</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The name passed to <code>ADD_PRIMITIVE</code> is the C function name.</p>
</div>
<div class="sect2">
<h3 id="_calling_scheme_primitives">6.1. Calling Scheme primitives</h3>
<div class="paragraph">
<p>Recall that a primitive is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">DEFINE_PRIMITIVE</span><span class="p">(</span><span class="s">"fixnum?"</span><span class="p">,</span> <span class="n">fixnump</span><span class="p">,</span> <span class="n">subr1</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">obj</span><span class="p">))</span>
<span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

<span class="n">ADD_PRIMITIVE</span><span class="p">(</span><span class="n">fixnump</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this primitive later in C code, add the <code>STk_</code> prefix to its C
function name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">STk_fixnump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">STk_false</span><span class="p">)</span> <span class="p">...</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_multiple_values">6.2. Returning multiple values</h3>
<div class="paragraph">
<p><code>STk_n_values(n, v1, v2, &#8230;&#8203;, vn)</code> returns <code>n</code> values from a procedure.</p>
</div>
<div class="paragraph">
<p>For example, <code>read-line</code> (defined in <code>port.c</code>) has these two lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">return</span> <span class="n">STk_n_values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">STk_eof</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>for when it found the end of the file, and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">return</span> <span class="nf">STk_n_values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>for when it did not yet reach EOF, so it returns the line delimiter as
second value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_multiple_returned_values">6.3. Using multiple returned values</h3>
<div class="paragraph">
<p>Just as one can use <code>STk_n_values</code> to produce values, it is also possible
to call (from C) a Scheme procedure that produces a sequence of values
and use them from the C code. The function <code>STk_values2vector</code> (defined
in <code>vm.c</code>) does this.</p>
</div>
<div class="paragraph">
<p>In Scheme, one could to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">my-proc</span> <span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span><span class="p">)</span>        <span class="c1">;; takes three arguments</span>
  <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">y</span> <span class="nv">z</span><span class="p">)))</span>    <span class="c1">;; returns two values</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we assume that the C <code>SCM</code> variable <code>proc</code> points to the closure
<code>my-proc</code>, then we can call it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">SCM</span> <span class="n">a</span> <span class="o">=</span> <span class="n">MAKE_INT</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">SCM</span> <span class="n">b</span> <span class="o">=</span> <span class="n">MAKE_INT</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="n">SCM</span> <span class="n">c</span> <span class="o">=</span> <span class="n">MAKE_INT</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

<span class="cm">/* Define a Scheme vector to hold EXACTLY two values: */</span>
<span class="n">SCM</span> <span class="n">results</span> <span class="o">=</span> <span class="n">STk_makevect</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="n">VECTOR_DATA</span><span class="p">(</span><span class="n">results</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">STk_false</span><span class="p">;</span>
<span class="n">VECTOR_DATA</span><span class="p">(</span><span class="n">results</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">STk_false</span><span class="p">;</span>

<span class="cm">/* Call the procedure proc, passing 3 arguments; proc */</span>
<span class="n">STk_values2vector</span> <span class="p">(</span> <span class="n">STk_C_apply</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                    <span class="n">results</span> <span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Scheme vector <code>results</code> will then hold the two returned values.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you pass <code>NULL</code> as second argument to <code>STk_values2vector</code> instead
of passing a vector, the VM will allocate a vector with the size of
the number of values returned.</p>
</li>
<li>
<p>If you do pass a vector to <code>STk_values2vector</code>, then the procedure
being called <strong>must</strong> produce <strong>exactly</strong> that number of values (not
more, not less), otherwise the VM will signal an error.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_errors">6.4. Errors</h3>
<div class="paragraph">
<p>The C function that raises errors is</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_error(fmt, arg1, arg2, &#8230;&#8203;)</code> – the STklos error procedure. <code>fmt</code>
is a format string, and after it there are arguments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But as you can see in the top of several C files, it is useful to define
wrappers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">error_bad_number</span><span class="p">(</span><span class="n">SCM</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">STk_error</span><span class="p">(</span><span class="s">"~S is a bad number"</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">error_at_least_1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">STk_error</span><span class="p">(</span><span class="s">"expects at least one argument"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">error_cannot_operate</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">o1</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">o2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">STk_error</span><span class="p">(</span><span class="s">"cannot perform %s on ~S and ~S"</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unboxed_types">6.5. Unboxed types</h3>
<div class="paragraph">
<p>The trditional way to representa data in Lisp languages is by <em>tagged
objects</em>. A long enough machine word is used to represent all types, and
some bits are reserved to distinguish the type of the object. In STklos,
the <em>two least significant bits</em> are used for this.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>00</code> - pointer on an object descriptor (a box)</p>
</li>
<li>
<p><code>01</code> - fixnum</p>
</li>
<li>
<p><code>10</code> - small object (characters and others)</p>
</li>
<li>
<p><code>11</code> - small constant (<code>#t</code>, <code>#f</code>, <code>'()</code>, <code>#eof</code>, <code>#void</code>, dot,
close-parenthesis)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The idea is that checking the type of these should be very fast, because
it is done at runtime, so to check wether an object is <code>#eof</code>, one needs
only check if <code>obj &amp; 0x4 == 0x3</code> (but usually, we have macros for that).</p>
</div>
<div class="paragraph">
<p>STklos uses C <code>long</code> words so, for example, in a machine where
<code>long int</code> is 32 bits long the bit sequence</p>
</div>
<div class="literalblock">
<div class="content">
<pre>0000 0000 0000 0000 0000 0000 0010 0101</pre>
</div>
</div>
<div class="paragraph">
<p>is a <em>fixnum</em> (because its two least significant digits are <code>01</code>, and
the value of the fixnum is 9 (because after discarding the <code>01</code> that is
on the right of the sequence, the number left is <code>1001</code>).</p>
</div>
<div class="sect3">
<h4 id="_booleans">6.5.1. Booleans</h4>
<div class="ulist">
<ul>
<li>
<p><code>STk_true</code> is the SCM object for <code>#t</code></p>
</li>
<li>
<p><code>STk_false</code> is the SCM object for <code>#f</code></p>
</li>
<li>
<p><code>BOOLEANP(o)</code> checks wether the object <code>o</code> is boolean (the macro
actually does <code>(o) == STk_true) || ((o) == STk_false</code></p>
</li>
<li>
<p><code>MAKE_BOOLEAN(_cond)</code> expands to a conditional statement: if <code>_cond</code>
is true, then the value is <code>STk_true</code>, otherwise it is <code>STk_false</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_fixnums">6.5.2. Fixnums</h4>
<div class="paragraph">
<p>Fixnums are not allocated but have their two least significant bits set
to <code>01</code> (in Lisp-parlance, it has <code>01</code> as its <em>tag</em>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INTP(o)</code> - returns STklos_true if <code>o</code> is a Scheme integer or
<code>STklos_false</code> otherwise</p>
</li>
<li>
<p><code>MAKE_INT(n)</code> - takes a <code>long</code> C number and turns it into an <code>SCM</code>
integer object. Actually, this will shift the number to the left by two
positions and insert the tag If we could represent numbers as binary in
C, it would be like this:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">MAKE_INT</span><span class="p">(</span> <span class="mo">000011000</span> <span class="p">)</span>  <span class="c1">// --&gt; 001100001</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>INT_VAL(o)</code> - returns the value of the fixnum <code>o</code>, as a C <code>long</code>
value (the opposite of the previous operation)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_boxed_types">6.6. Boxed types</h3>
<div class="paragraph">
<p>Boxed types are anything except for fixnums, small objects and small
constants. They are tagged with <code>00</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>BOXED_OBJP(o)</code> – true if <code>o</code> is a boxed object</p>
</li>
<li>
<p><code>BOXED_TYPE_EQ(o,t)</code> – checks wether <code>o</code> is a boxed object of type <code>t</code></p>
</li>
<li>
<p><code>BOXED_TYPE(o)</code> – returns the type of boxed object <code>o</code></p>
</li>
<li>
<p><code>BOXED_INFO</code> – returns the information of boxed object <code>o</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The type definition for all possible types, in <code>stklos.h</code>, is
self-explanatory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">tc_not_boxed</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">tc_cons</span><span class="p">,</span> <span class="n">tc_integer</span><span class="p">,</span> <span class="n">tc_real</span><span class="p">,</span> <span class="n">tc_bignum</span><span class="p">,</span>  <span class="n">tc_rational</span><span class="p">,</span>                <span class="cm">/* 0 */</span>
  <span class="n">tc_complex</span><span class="p">,</span> <span class="n">tc_symbol</span><span class="p">,</span> <span class="n">tc_keyword</span><span class="p">,</span> <span class="n">tc_string</span><span class="p">,</span> <span class="n">tc_module</span><span class="p">,</span>              <span class="cm">/* 5 */</span>
  <span class="n">tc_instance</span><span class="p">,</span> <span class="n">tc_closure</span><span class="p">,</span> <span class="n">tc_subr0</span><span class="p">,</span> <span class="n">tc_subr1</span><span class="p">,</span> <span class="n">tc_subr2</span><span class="p">,</span>                <span class="cm">/* 10 */</span>
  <span class="n">tc_subr3</span><span class="p">,</span> <span class="n">tc_subr4</span><span class="p">,</span> <span class="n">tc_subr5</span><span class="p">,</span> <span class="n">tc_subr01</span><span class="p">,</span> <span class="n">tc_subr12</span><span class="p">,</span>                   <span class="cm">/* 15 */</span>
  <span class="n">tc_subr23</span><span class="p">,</span> <span class="n">tc_vsubr</span><span class="p">,</span> <span class="n">tc_apply</span><span class="p">,</span> <span class="n">tc_vector</span><span class="p">,</span> <span class="n">tc_uvector</span><span class="p">,</span>                 <span class="cm">/* 20 */</span>
  <span class="n">tc_hash_table</span><span class="p">,</span> <span class="n">tc_port</span><span class="p">,</span> <span class="n">tc_frame</span><span class="p">,</span> <span class="n">tc_next_method</span><span class="p">,</span> <span class="n">tc_promise</span><span class="p">,</span>         <span class="cm">/* 25 */</span>
  <span class="n">tc_regexp</span><span class="p">,</span> <span class="n">tc_process</span><span class="p">,</span> <span class="n">tc_continuation</span><span class="p">,</span> <span class="n">tc_values</span><span class="p">,</span> <span class="n">tc_parameter</span><span class="p">,</span>      <span class="cm">/* 30 */</span>
  <span class="n">tc_socket</span><span class="p">,</span> <span class="n">tc_struct_type</span><span class="p">,</span> <span class="n">tc_struct</span><span class="p">,</span> <span class="n">tc_thread</span><span class="p">,</span> <span class="n">tc_mutex</span><span class="p">,</span>            <span class="cm">/* 35 */</span>
  <span class="n">tc_condv</span><span class="p">,</span> <span class="n">tc_box</span><span class="p">,</span> <span class="n">tc_ext_func</span><span class="p">,</span> <span class="n">tc_pointer</span><span class="p">,</span> <span class="n">tc_callback</span><span class="p">,</span>               <span class="cm">/* 40 */</span>
  <span class="n">tc_last_standard</span> <span class="cm">/* must be last as indicated by its name */</span>
<span class="p">}</span> <span class="n">type_cell</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_lists">6.6.1. Lists</h4>
<div class="paragraph">
<p>Here are some primitives for lists, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CAR(p)</code> – equivalent to Scheme <code>car</code>: returns the car of <code>p</code> (an SCM
object)</p>
</li>
<li>
<p><code>CDR(p)</code> – equivalent to Scheme <code>cdr</code>: returns the car of <code>p</code> (an SCM
object, which certainly is a list)</p>
</li>
<li>
<p><code>CONSP(p)</code> - equivalent to Scheme <code>cons?</code></p>
</li>
<li>
<p><code>NULLP(p)</code> - equivalent to Scheme <code>null?</code></p>
</li>
<li>
<p><code>STk_cons</code> - equivalent to Scheme <code>cons</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_strings">6.6.2. Strings</h4>
<div class="paragraph">
<p>Another example are strings. They are defined as the following
structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">string_obj</span> <span class="p">{</span>
  <span class="n">stk_header</span> <span class="n">header</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">space</span><span class="p">;</span>            <span class="cm">/* allocated size  */</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>             <span class="cm">/* # of bytes used */</span>
  <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>           <span class="cm">/* "external" length of the string */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, some primitives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#define STRING_SPACE(p)  (((struct string_obj *) (p))-&gt;space)
#define STRING_SIZE(p)   (((struct string_obj *) (p))-&gt;size)
#define STRING_LENGTH(p) (((struct string_obj *) (p))-&gt;length)
#define STRING_CHARS(p)  (((struct string_obj *) (p))-&gt;chars)
#define STRINGP(p)       (BOXED_TYPE_EQ((p), tc_string))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following primitives are defined in a <code>str.c</code>, but <code>stklos.h</code> is
used by several files use them, so they’re included with
<code>EXTERN_PRIMITIVE</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="n">EXTERN_PRIMITIVE</span><span class="p">(</span><span class="s">"string=?"</span><span class="p">,</span> <span class="n">streq</span><span class="p">,</span> <span class="n">subr2</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">s1</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">s2</span><span class="p">));</span>
<span class="n">EXTERN_PRIMITIVE</span><span class="p">(</span><span class="s">"string-ref"</span><span class="p">,</span> <span class="n">string_ref</span><span class="p">,</span> <span class="n">subr2</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">str</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">index</span><span class="p">));</span>
<span class="n">EXTERN_PRIMITIVE</span><span class="p">(</span><span class="s">"string-set!"</span><span class="p">,</span> <span class="n">string_set</span><span class="p">,</span> <span class="n">subr3</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">str</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">index</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">value</span><span class="p">));</span>
<span class="n">EXTERN_PRIMITIVE</span><span class="p">(</span><span class="s">"string-downcase!"</span><span class="p">,</span> <span class="n">string_ddowncase</span><span class="p">,</span> <span class="n">vsubr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">SCM</span> <span class="o">*</span><span class="n">argv</span><span class="p">));</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dynamically_loadable_modules">6.7. Dynamically loadable modules</h3>
<div class="paragraph">
<p>See some examples in <code>etc/</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_input_and_output_from_c">6.8. Input and output from C</h3>
<div class="paragraph">
<p>The input and output functions are defined in <code>sio.c</code>, and
declared in <code>stklos.h</code>. For example,</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_getc(SCM port)</code> for reading a single character</p>
</li>
<li>
<p><code>STk_get_character(SCM port)</code> for reading a single character (result may be a wide char)</p>
</li>
<li>
<p><code>STk_putc(int c, SCM port)</code> for printing a single character</p>
</li>
<li>
<p><code>STk_put_character(int c, SCM port)</code> for printing a single character (maybe a wide char)</p>
</li>
<li>
<p><code>STk_puts(const char *s, SCM port)</code> for printing a C string</p>
</li>
<li>
<p><code>STk_putstring(const char *s, SCM port)</code> for printing a Scheme string</p>
</li>
<li>
<p><code>STk_print(SCM exp, SCM port, int mode)</code> for printing Scheme objects</p>
</li>
<li>
<p><code>STk_print_star(SCM exp, SCM port, int mode)</code> for circular structures</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All printing procedures have a <code>port</code> argument. This should be a Scheme
object of the type <code>port</code>, and there are also already defined ports for
standard output and error, <code>STk_stdout</code> and <code>STk_stderr</code>. For
reading there is also <code>STk_stdin</code>. These standard ports are defined in
<code>fport.c</code>, and declared (as <code>extern</code>) in <code>stklos.h</code>. They are all initialized
in the function <code>STk_init_fport</code> in <code>fport.c</code>.</p>
</div>
<div class="paragraph">
<p>Some printing procedures have a <code>mode</code> argument. The two allowed values
for this are <code>WRT_MODE</code> and <code>DSP_MODE</code>, which correspond to "write mode"
(which will write the raw representation of objects) and "display mode"
(which will do pretty-printing). The difference can be clearly seen in
the <code>printstring</code> function in <code>print.c</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">printstring</span><span class="p">(</span><span class="n">SCM</span> <span class="n">s</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DSP_MODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">STk_putstring</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="cm">/* lots of code dealing with character escapes */</span>
  <span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_new_types">6.9. Creating new types</h3>
<div class="sect3">
<h4 id="_example_srfi_25">6.9.1. Example: SRFI-25</h4>
<div class="paragraph">
<p>We’ll be using SRFI-25 as an example. In that SRFI, am <code>array</code> type is
created.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a C struct whose first field is of type <code>stk_header</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">array_obj</span> <span class="p">{</span>
  <span class="n">stk_header</span> <span class="n">header</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">shared</span><span class="p">;</span>                <span class="cm">/* does this array share data with another? */</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">orig_share_count</span><span class="p">;</span>     <span class="cm">/* pointer to original array share counter */</span>
<span class="cp">#ifndef THREADS_NONE
</span>  <span class="n">MUT_FIELD</span><span class="p">(</span><span class="n">share_cnt_lock</span><span class="p">);</span> <span class="cm">/* lock for share counter */</span>
  <span class="n">MUT_FIELD</span><span class="p">(</span><span class="o">*</span><span class="n">share_cnt_lock_addr</span><span class="p">);</span> <span class="cm">/* pointer to mutex - ours or of original array's */</span>
<span class="cp">#endif
</span>  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>                 <span class="cm">/* size of data */</span>
  <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>               <span class="cm">/* # of elements */</span>
  <span class="kt">int</span>  <span class="n">rank</span><span class="p">;</span>                 <span class="cm">/* # of dimensons */</span>
  <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>               <span class="cm">/* offset from zero, to be added when calculaing index */</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">shape</span><span class="p">;</span>               <span class="cm">/* pairs of bounds for each dimenson */</span>
  <span class="kt">long</span> <span class="o">*</span><span class="n">multipliers</span><span class="p">;</span>         <span class="cm">/* size of each dimension stride */</span>
  <span class="n">SCM</span>  <span class="o">*</span><span class="n">data_ptr</span><span class="p">;</span>            <span class="cm">/* pointer to data */</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The fields in the struct may contain both C and Scheme elements (the
Scheme elements have <code>SCM</code> types).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maybe create some accessor macros</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#define ARRAYP(p)            (BOXED_TYPE_EQ((p), tc_array))
#define ARRAY_SHARED(p)      (((struct array_obj *) (p))-&gt;shared)
#define ARRAY_SHARE_COUNT(p) (((struct array_obj *) (p))-&gt;orig_share_count)
#define ARRAY_LOCK(p)        (*(((struct array_obj *) (p))-&gt;share_cnt_lock_addr))
#define ARRAY_SIZE(p)        (((struct array_obj *) (p))-&gt;size)
#define ARRAY_LENGTH(p)      (((struct array_obj *) (p))-&gt;length)
#define ARRAY_RANK(p)        (((struct array_obj *) (p))-&gt;rank)
#define ARRAY_OFFSET(p)      (((struct array_obj *) (p))-&gt;offset)
#define ARRAY_SHAPE(p)       (((struct array_obj *) (p))-&gt;shape)
#define ARRAY_MULTS(p)       (((struct array_obj *) (p))-&gt;multipliers)
#define ARRAY_DATA(p)        (((struct array_obj *) (p))-&gt;data_ptr)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Be mindful of thread-related things: not all STklos builds have
threading enabled!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#ifdef THREADS_NONE
#  define ARRAY_MUTEX(p)
#  define ARRAY_MUTEX_SIZE 1
#else
#  define ARRAY_MUTEX(p) (((struct array_obj *) (p))-&gt;share_cnt_lock)
#  define ARRAY_MUTEX_SIZE (sizeof(pthread_mutex_t))
#  define ARRAY_MUTEX_PTR_SIZE (sizeof(pthread_mutex_t*))
#endif</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an extended type descriptor which contains the type name, and
pointers to functions to print and compare elements:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_array</span><span class="p">(</span><span class="n">SCM</span> <span class="n">array</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/*
    Here goes the code for printing array.
    Use the functions
      - STk_puts(char *str, SCM port)
      - STk_print(SCM obj, SCM port, int mode)
    It may be useful to first create a buffer, use snprintf on it, then
    use STk_puts to print it.
   */</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="n">SCM</span> <span class="nf">test_equal_array</span><span class="p">(</span><span class="n">SCM</span> <span class="n">x</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
 <span class="cm">/*
   Code that retruns STk_true if x and y are to be considered `equal?`,
   and STk_false othereise.

   NOTE: remember to *NOT* return 0 or 1. The return value should be a Scheme
         object, not a C value with the intended boolean value. This is
         particularly important because the compiler will *NOT* warn you if you
         return "0":
         - `SCM` is defined as a pointer to `void`
         - '0' can be interpreted as a pointer, so the compiler thinks it's OK
         - '0' is *not* the same as `STk_void`
  */</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">extended_type_descr</span> <span class="n">xtype_array</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">"array"</span><span class="p">,</span>
  <span class="p">.</span><span class="n">print</span> <span class="o">=</span> <span class="n">print_array</span><span class="p">,</span>
  <span class="p">.</span><span class="n">equal</span> <span class="o">=</span> <span class="n">test_equal_array</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>At the end of your C code, inside the MODULE_ENTRY_START part,
initialize an element of the new type:
<code>tc_array = STk_new_user_type(&amp;xtype_array);</code></p>
</li>
<li>
<p>Create a describing procedure:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">%user-type-proc-set!</span> <span class="ss">'array</span> <span class="ss">'describe</span>
                      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">x</span> <span class="nv">port</span><span class="p">)</span>
                        <span class="p">(</span><span class="nf">format</span> <span class="nv">port</span> <span class="s">"an array of rank ~A and size ~A"</span>
                                <span class="p">(</span><span class="nf">array-rank</span> <span class="nv">x</span><span class="p">)</span>
                                <span class="p">(</span><span class="nf">array-size</span> <span class="nv">x</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Define a class, and associate it with the type name you have created.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">define-class</span> <span class="nv">&lt;array&gt;</span> <span class="p">(</span><span class="nf">&lt;top&gt;</span><span class="p">)</span> <span class="p">())</span>
<span class="p">(</span><span class="nf">export</span> <span class="nv">&lt;array&gt;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">%user-type-proc-set!</span> <span class="ss">'array</span> <span class="ss">'class-of</span> <span class="nv">&lt;array&gt;</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If objects of the new type will have a printed representation, create
a reader procedure:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">define-reader-ctor</span> <span class="ss">'&lt;array&gt;</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="nv">args</span>
    <span class="p">(</span><span class="nb">apply</span> <span class="nv">array</span> <span class="p">(</span><span class="nb">apply</span> <span class="nv">shape</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">args</span><span class="p">))</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">args</span><span class="p">))))</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_more_about_creating_new_types">6.9.2. More about creating new types</h4>
<div class="paragraph">
<p>The structure for extended type descriptors is defined in <code>stklos.h</code>,
in section "EXTEND.C":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">extended_type_descr</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">print</span><span class="p">)(</span><span class="n">SCM</span> <span class="n">exp</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
  <span class="n">SCM</span>  <span class="p">(</span><span class="o">*</span><span class="n">equal</span><span class="p">)(</span><span class="n">SCM</span> <span class="n">o1</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">o2</span><span class="p">);</span>
  <span class="n">SCM</span>  <span class="p">(</span><span class="o">*</span><span class="n">eqv</span><span class="p">)(</span><span class="n">SCM</span> <span class="n">o1</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">o2</span><span class="p">);</span>
  <span class="n">SCM</span>  <span class="n">class_of</span><span class="p">;</span>
  <span class="n">SCM</span>  <span class="n">describe_proc</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen, there are other fields besides <code>name</code>, <code>print</code> and <code>equal</code>
that can be customized. For example, the <code>describe</code> behavior, which was
defined in Scheme for SRFI-25, could have been implemented in C.</p>
</div>
<div class="paragraph">
<p>Immediately below the definition of this structure, there are also some
useful macros and function declarations for dealing with extended types.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_continuations">7. Continuations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One macro and two functions are declared in <code>vm.h</code> that can be used to
capture, check and restore continuations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CONTP(k)</code> verifies (as expected) wether <code>k</code> is a continuation object</p>
</li>
<li>
<p><code>SCM STk_make_continuation(void)</code> returns the current continuation</p>
</li>
<li>
<p><code>SCM STk_restore_cont(SCM cont, SCM val)</code> restores continuation <code>cont</code>, passing it
the value <code>val</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is also one function in <code>vm.c</code> which is not exported by <code>vm.h</code>, but is available
as a Scheme primitive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">DEFINE_PRIMITIVE</span><span class="p">(</span><span class="s">"%fresh-continuation?"</span><span class="o">,</span> <span class="nv">fresh_continuationp,</span> <span class="nv">subr1,</span> <span class="p">(</span><span class="nf">SCM</span> <span class="nv">obj</span><span class="p">))</span>
<span class="err">{</span>
  <span class="nv">return</span> <span class="nv">MAKE_BOOLEAN</span><span class="p">(</span><span class="nf">CONTP</span><span class="p">(</span><span class="nf">obj</span><span class="p">)</span> <span class="nv">&amp;&amp;</span> <span class="p">(((</span><span class="nf">struct</span> <span class="nv">continuation_obj</span> <span class="nv">*</span><span class="p">)</span> <span class="nv">obj</span><span class="p">)</span><span class="nv">-&gt;fresh</span><span class="p">))</span><span class="c1">;</span>
<span class="err">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Their Scheme counterparts, <code>%continuation?</code>, <code>%make-continuation</code>, and
<code>%restore-continuation</code> are used to implement the Scheme procedure
<code>call/cc</code> (in <code>lib/callcc.stk</code>). The implementation of <code>call/cc</code> is
actually complex because it needs to be intertwined with the
implementation of <code>dynamic-wind</code>, but in the same file there is
another procedure, <code>%call/cc</code>, which does not do winding, and is
therefore very simple (and it should be the starting point to
understand the full-blown <code>call/cc</code>). We reproduce it here with some
comments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">%call/cc</span> <span class="nv">proc</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">k</span>  <span class="p">(</span><span class="nf">%make-continuation</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span>  <span class="p">(</span><span class="nf">%fresh-continuation?</span> <span class="nv">k</span><span class="p">)</span>

         <span class="c1">;; In the first time we get here, we create a closure (the lambda</span>
         <span class="c1">;; below) that will take a value v and restore the continuation</span>
         <span class="c1">;; k with it. So when we call</span>
         <span class="c1">;; (%call/cc (lambda (kont) ... (kont x) ...)),</span>
         <span class="c1">;; 'proc' below is the '(lambda (kont) ...)' in our code. And the</span>
         <span class="c1">;; '(lambda v ...)' below is kont. 'v' is the argument that will be</span>
         <span class="c1">;; given to kont.</span>

         <span class="p">(</span><span class="nf">proc</span> <span class="p">(</span><span class="k">lambda</span> <span class="nv">v</span> <span class="p">(</span><span class="nf">%restore-continuation</span> <span class="nv">k</span> <span class="nv">v</span><span class="p">)))</span>

         <span class="c1">;; Next time and everytime again, we just return values applied to k,</span>
         <span class="c1">;; because in this case, k will *not* be a continuation, but a list</span>
         <span class="c1">;; with the values passed (this is because the lambda above accepts</span>
         <span class="c1">;; 'v' as the arg list, and this list is passed to %restore-continuation</span>
         <span class="c1">;; as the value to be returned).</span>
         <span class="p">(</span><span class="nb">apply</span> <span class="nv">values</span> <span class="nv">k</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>%call/cc</code> procedure is used in the same way the Scheme <code>call/cc</code>
is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">stklos&gt;</span> <span class="p">(</span><span class="k">define</span> <span class="nv">c</span> <span class="no">#f</span><span class="p">)</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">b</span> <span class="mi">2</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">"start~%"</span><span class="p">)</span>
  <span class="p">(</span><span class="k">set!</span> <span class="nv">b</span> <span class="p">(</span><span class="nf">%call/cc</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">k</span><span class="p">)</span>
                      <span class="p">(</span><span class="k">set!</span> <span class="nv">c</span> <span class="nv">k</span><span class="p">)</span>
                      <span class="mi">-1</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">a</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">"~a ~a ~a~%"</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>

<span class="nv">start</span>
<span class="mi">2</span> <span class="mi">-1</span> <span class="o">#</span><span class="p">[</span><span class="nf">closure</span> <span class="mi">7</span><span class="nv">fbcd9a122c0</span><span class="p">]</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">c</span> <span class="mi">15</span><span class="p">)</span>
<span class="mi">3</span> <span class="mi">15</span> <span class="o">#</span><span class="p">[</span><span class="nf">closure</span> <span class="mi">7</span><span class="nv">fbcd9a122c0</span><span class="p">]</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">c</span> <span class="ss">'x</span><span class="p">)</span>
<span class="mi">4</span> <span class="nv">x</span> <span class="o">#</span><span class="p">[</span><span class="nf">closure</span> <span class="mi">7</span><span class="nv">fbcd9a122c0</span><span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior of the fundamental continuation procedures is better
illustrated by an example in Scheme, which mimics the example of
<code>%call/cc</code> given above, <strong>ecxept</strong> that it does not have the return
value of <code>%call/cc</code>, so it does not set the value of <code>b</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">stklos&gt;</span> <span class="p">(</span><span class="k">define</span> <span class="nv">c</span> <span class="no">#f</span><span class="p">)</span>  <span class="c1">; to be set later</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">a</span> <span class="mi">1</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">b</span> <span class="mi">2</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">"start~%"</span><span class="p">)</span>
  <span class="p">(</span><span class="k">set!</span> <span class="nv">c</span> <span class="p">(</span><span class="nf">%make-continuation</span><span class="p">))</span>
  <span class="p">(</span><span class="k">set!</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">a</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">"~a ~a ~a~%"</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>

<span class="nv">start</span>
<span class="mi">2</span> <span class="mi">2</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%continuation?</span> <span class="nv">c</span><span class="p">)</span>
<span class="no">#t</span>

<span class="nv">stklos&gt;</span> <span class="nv">c</span>
<span class="o">#</span><span class="p">[</span><span class="nf">continuation</span> <span class="p">(</span><span class="nf">C=3992</span> <span class="nv">S=1512</span><span class="p">)</span> <span class="nv">c069e000</span><span class="p">]</span>     <span class="c1">;; addresses: C stack, Scheme stack,</span>
                                             <span class="c1">;; continuation object</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%fresh-continuation?</span> <span class="nv">c</span><span class="p">)</span>
<span class="no">#t</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%restore-continuation</span> <span class="nv">c</span> <span class="nv">c</span><span class="p">)</span>          <span class="c1">;; since this is the continuation of</span>
                                             <span class="c1">;; "(set! c ...)", we put "c" as value,</span>
                                             <span class="c1">;; so we can use the continuation again</span>
<span class="mi">3</span> <span class="mi">2</span> <span class="o">#</span><span class="p">[</span><span class="nf">continuation</span> <span class="p">(</span><span class="nf">C=3992</span> <span class="nv">S=1512</span><span class="p">)</span> <span class="nv">c069e000</span><span class="p">]</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%fresh-continuation?</span> <span class="nv">c</span><span class="p">)</span>
<span class="no">#f</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%restore-continuation</span> <span class="nv">c</span> <span class="nv">c</span><span class="p">)</span>
<span class="mi">4</span> <span class="mi">2</span> <span class="o">#</span><span class="p">[</span><span class="nf">continuation</span> <span class="p">(</span><span class="nf">C=3992</span> <span class="nv">S=1512</span><span class="p">)</span> <span class="nv">c069e000</span><span class="p">]</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%restore-continuation</span> <span class="nv">c</span> <span class="nv">c</span><span class="p">)</span>
<span class="mi">5</span> <span class="mi">2</span> <span class="o">#</span><span class="p">[</span><span class="nf">continuation</span> <span class="p">(</span><span class="nf">C=3992</span> <span class="nv">S=1512</span><span class="p">)</span> <span class="nv">c069e000</span><span class="p">]</span>

<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">%restore-continuation</span> <span class="nv">c</span> <span class="nv">c</span><span class="p">)</span>
<span class="mi">6</span> <span class="mi">2</span> <span class="o">#</span><span class="p">[</span><span class="nf">continuation</span> <span class="p">(</span><span class="nf">C=3992</span> <span class="nv">S=1512</span><span class="p">)</span> <span class="nv">c069e000</span><span class="p">]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_virtual_machine">8. The virtual machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See the file <code>vm.adoc</code> for a description of the opcodes.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compiler_and_optimizations">9. Compiler and optimizations</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_compiler">9.1. The compiler</h3>
<div class="paragraph">
<p>The compiler is in the file <code>lib/compiler.stk</code>.</p>
</div>
<div class="paragraph">
<p>There is a <code>compile</code> procedure at the end of the file, whose logic is
very simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>expand macros</p>
</li>
<li>
<p>compile special forms</p>
</li>
<li>
<p>if what’s left is a symbol, compile a call</p>
</li>
<li>
<p>if it’s not a symbol, compile it as a constant</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the rest of the file, there are procedures to compile different
special forms and inlinable primitives.</p>
</div>
<div class="paragraph">
<p>The code is generated as a list, in the <code><strong>code-instr</strong></code> global variable
in the <code>STKLOS-COMPILER</code> module. The procedure <code>emit</code> conses one more
instruction on the code (which will later be reversed, of course)</p>
</div>
</div>
<div class="sect2">
<h3 id="_peephole_optimizer">9.2. Peephole optimizer</h3>
<div class="paragraph">
<p>STklos uses a peephole optimzier, located in the file
<code>lib/peephole.stk</code>. This optimizer will transform several instruction
patterns in the generated code into more efficient ones. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme">             <span class="c1">;; [SMALL-INT, PUSH] =&gt; INT-PUSH</span>
             <span class="p">((</span><span class="k">and</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">i1</span> <span class="ss">'SMALL-INT</span><span class="p">)</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">i2</span> <span class="ss">'PUSH</span><span class="p">))</span>
              <span class="p">(</span><span class="nf">replace-2-instr</span> <span class="nv">code</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'INT-PUSH</span> <span class="p">(</span><span class="nf">this-arg1</span> <span class="nv">code</span><span class="p">))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This transforms two instructions (<code>`load a small integer into `val</code>,
then push it onto the stack'') into one single instruction (push an
integer onto the stack).</p>
</div>
<div class="paragraph">
<p>The peephole optimizer also reduces the size of the bytecode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme">             <span class="c1">;; [RETURN; RETURN] =&gt; [RETURN]</span>
             <span class="p">((</span><span class="k">and</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">i1</span> <span class="ss">'RETURN</span><span class="p">)</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">i2</span> <span class="ss">'RETURN</span><span class="p">))</span>
              <span class="p">(</span><span class="nf">replace-2-instr</span> <span class="nv">code</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'RETURN</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will turn two adjacent <code>RETURN</code> instructions into a single one,
making the object file smaller. This is valid because there won’t be any
<code>GOTO</code> pointing to the second instruction; if this was the case, then
the code would have a label between the two `RETURN`s.</p>
</div>
<div class="paragraph">
<p>Another example is <code>GOTO</code> optimization:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme">             <span class="c1">;; [GOTO x], ... ,x: GOTO y =&gt; GOTO y</span>
             <span class="c1">;; [GOTO x], ... ,x: RETURN =&gt; RETURN</span>
             <span class="p">((</span><span class="nb">eq?</span> <span class="nv">i1</span> <span class="ss">'GOTO</span><span class="p">)</span>
              <span class="p">(</span><span class="k">set!</span> <span class="nv">code</span> <span class="p">(</span><span class="nf">optimize-goto</span> <span class="nv">code</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The procedure <code>optimize-goto-code</code>, also in the file <code>peephole.stk</code>,
will perform the transformations indicated in the comments.</p>
</div>
<div class="paragraph">
<p>The input code is represented as a list of the form</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span> <span class="p">(</span><span class="nf">instruction1</span> <span class="nv">op1</span> <span class="nv">op2</span><span class="p">)</span>    <span class="c1">;; one instruction with two operands</span>
  <span class="p">(</span><span class="nf">instruction2</span> <span class="nv">op1</span><span class="p">)</span>        <span class="c1">;; one instruction with one operand</span>
  <span class="p">(</span><span class="nf">instruction3</span><span class="p">)</span>            <span class="c1">;; one instruction with no operands</span>
  <span class="o">...</span>
  <span class="p">(</span><span class="nf">instruction10</span> <span class="nv">op1</span> <span class="nv">op2</span><span class="p">)</span>
  <span class="mi">10</span>                        <span class="c1">;; this is a label!</span>
  <span class="p">(</span><span class="nf">instruction11</span><span class="p">)</span>
  <span class="o">...</span> <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some relevant definitions are in the beginning of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">label?</span> <span class="nv">code</span><span class="p">)</span>      <span class="c1">; is the current instruction a label?</span>
<span class="p">(</span><span class="nf">this-instr</span> <span class="nv">code</span><span class="p">)</span>  <span class="c1">; the current instruction (reference to a position in the list)</span>
<span class="p">(</span><span class="nf">next-instr</span> <span class="nv">code</span><span class="p">)</span>  <span class="c1">; the next instruction (cdr of the current one)</span>
<span class="p">(</span><span class="nf">this-arg1</span> <span class="nv">code</span><span class="p">)</span>   <span class="c1">; argument 1 of current instruction</span>
<span class="p">(</span><span class="nf">this-arg2</span> <span class="nv">code</span><span class="p">)</span>   <span class="c1">; argument 2 of current instruction</span>
<span class="p">(</span><span class="nf">next-arg1</span> <span class="nv">code</span><span class="p">)</span>   <span class="c1">; argument 1 of next instruction</span>
<span class="p">(</span><span class="nf">next-arg2</span> <span class="nv">code</span><span class="p">)</span>   <span class="c1">; argument 2 of next instruction</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are only procedures for dealing with the current and the next
instruction because the peephole optimizer currently only substitutes
sequences of two instructions. It is an interesting exercise to try to
implement three-instruction peephole operation. As a suggestion, the
reader can try the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implement <code>third-instr</code>. Be careful to not try to take the <code>cdr</code> of
an empty list&#8230;&#8203;</p>
</li>
<li>
<p>Include one more optimization clause in the optimizer that performs the
substitution
<code>[IN-CDR; IN-CDR; IN-CDR] &#8658; IN-CDDDR</code></p>
</li>
<li>
<p>And of course, implement <code>IN-CDDDR</code>:</p>
<div class="ulist">
<ul>
<li>
<p>Change <code>lib/assembler.stk</code></p>
</li>
<li>
<p>Change <code>src/vm-instr.h</code></p>
</li>
<li>
<p>Add one more case to the VM state machine (use the case for <code>IN_CDR</code>
as a starting point).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Finally, write some benchmark to verify if the new optimization is worth
the trouble (and the use of a new opcode).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_source_rewriter">9.3. Source rewriter</h3>
<div class="paragraph">
<p>The file <code>lib/comprewrite.stk</code> contains rules for code rewriting.</p>
</div>
<div class="paragraph">
<p>All the rewriting rules are stored in an compiler internal hash table, whose
keys are symbols The value stored for key <code>SYMBOL</code> is a procedure that
transforms the form <code>(SYMBOL &#8230;&#8203;)</code> into something else. For example, it will
transform <code>(IF 1 2 3)</code> into <code>2</code>.  The procedure takes as parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An expression (whose first element is the symbol that was used as key in
the hash table);</p>
</li>
<li>
<p>The length of the expression;</p>
</li>
<li>
<p>The environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The procedure should, of course, return the optimized expression. This procedure
can be obtained by the function <code>compiler:find-rewriter</code>, as seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="k">define</span> <span class="nv">rewrite-car</span> <span class="p">(</span><span class="nf">compiler:find-rewriter</span> <span class="ss">'car</span><span class="p">))</span>
<span class="p">(</span><span class="nf">rewrite-car</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="o">'</span><span class="p">(</span><span class="nf">1</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="ss">'1</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">rewrite-not</span> <span class="p">(</span><span class="nf">compiler:find-rewriter</span> <span class="ss">'not</span><span class="p">))</span>
<span class="p">(</span><span class="nf">rewrite-not</span> <span class="o">'</span><span class="p">(</span><span class="nb">not</span> <span class="no">#t</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the expression doesn&#8217;t seems correct, or cannot be simplified, nothing is
done (since the rewriter is not where syntax or semantic errors are detected):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">rewrite-car</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="o">'</span><span class="p">(</span><span class="nf">1</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="ss">'1</span>
<span class="p">(</span><span class="nf">rewrite-car</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span>  <span class="mi">4</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="nf">rewrite-car</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="nv">a-list</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="nv">a-list</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>compiler:add-rewriter!</code> adds a new rewriting rule to the
compiler. For instance, we can add a rule that transforms the calls to
the <code>eof-object</code> standard primitive to the STklos constant <code>#eof</code> (this
rewriter is already defined in the compiler)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">compiler:add-rewriter!</span>            <span class="c1">;; 'EOF-OBJECT' rewriter</span>
 <span class="ss">'eof-object</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">expr</span> <span class="nv">len</span> <span class="nv">env</span><span class="p">)</span>
   <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">len</span> <span class="mi">1</span><span class="p">)</span>
       <span class="o">#</span><span class="nv">eof</span>
       <span class="nv">expr</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">eof-rewriter</span> <span class="p">(</span><span class="nf">compiler:find-rewriter</span> <span class="ss">'eof-object</span><span class="p">))</span>
<span class="p">(</span><span class="nf">eof-rewriter</span> <span class="o">'</span><span class="p">(</span><span class="nf">eof-object</span><span class="p">)</span>   <span class="mi">1</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="o">#</span><span class="nv">efo</span>
<span class="p">(</span><span class="nf">eof-rewriter</span> <span class="o">'</span><span class="p">(</span><span class="nf">eof-object</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="nf">eof-object</span> <span class="mi">1</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The parameter object <code>compiler:source-rewrite</code> can be used to control source
rewriting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">compiler:source-rewrite</span> <span class="no">#f</span><span class="p">)</span>
<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="o">'</span><span class="p">(</span><span class="nf">1</span> <span class="mi">2</span><span class="p">)))</span>

<span class="mi">000</span><span class="nv">:</span>  <span class="nv">CONSTANT</span>             <span class="mi">0</span>      <span class="c1">;; that is the list '(1 2)</span>
<span class="mi">002</span><span class="nv">:</span>  <span class="nv">IN-CAR</span>
<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">compiler:source-rewrite</span> <span class="no">#t</span><span class="p">)</span>
<span class="nv">stklos&gt;</span> <span class="p">(</span><span class="nf">disassemble-expr</span> <span class="o">'</span><span class="p">(</span><span class="nb">car</span> <span class="o">'</span><span class="p">(</span><span class="nf">1</span> <span class="mi">2</span><span class="p">)))</span>

<span class="mi">000</span><span class="nv">:</span>  <span class="nv">IM-ONE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Rewriting rules can be defined without modifying the compiler thanks to the following functions</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>(compiler:const-expr? e)</code> which returns <code>#t</code> if the expression <code>e</code> is constant</p>
</li>
<li>
<p><code>(compiler:const-value e)</code> which returns the value of the constant expression <code>e</code></p>
</li>
<li>
<p><code>(compiler:rewrite-expression e env)</code> which returns a simplified version of
expression <code>e</code> in the environment <code>e</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We are now able to write a rewriting rule for <code>not</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="scheme"><span class="p">(</span><span class="nf">compiler:add-rewriter!</span>            <span class="c1">;; 'NOT' rewriter</span>
 <span class="ss">'not</span>
 <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">expr</span> <span class="nv">len</span> <span class="nv">env</span><span class="p">)</span>
   <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">len</span> <span class="mi">2</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">val</span> <span class="p">(</span><span class="nf">compiler:rewrite-expression</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">expr</span><span class="p">)</span> <span class="nv">env</span><span class="p">)))</span>
         <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">compiler:const-expr?</span> <span class="nv">val</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nf">compiler:const-value</span> <span class="nv">val</span><span class="p">))</span>
             <span class="nv">expr</span><span class="p">))</span>
       <span class="nv">expr</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">compiler:rewrite-expression</span> <span class="o">'</span><span class="p">(</span><span class="nb">not</span> <span class="mi">42</span><span class="p">)</span>            <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span>
           <span class="nv">=&gt;</span> <span class="no">#f</span>
<span class="p">(</span><span class="nf">compiler:rewrite-expression</span> <span class="o">'</span><span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">not</span> <span class="mi">42</span><span class="p">))</span>      <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span>
           <span class="nv">=&gt;</span> <span class="no">#t</span>
<span class="p">(</span><span class="nf">compiler:rewrite-expression</span> <span class="o">'</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="mi">42</span><span class="p">)</span> <span class="mi">10</span> <span class="mi">12</span><span class="p">)</span> <span class="p">(</span><span class="nb">interaction-environment</span><span class="p">))</span>
           <span class="nv">=&gt;</span> <span class="mi">12</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_garbage_collection">10. Garbage collection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>STklos uses the Boehm-Demers-Weiser garbage collector. The wrapper for
the GC is located in the header file <code>src/stklos.h</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#define STk_must_malloc(size)           GC_MALLOC(size)
#define STk_must_malloc_atomic(size)    GC_MALLOC_ATOMIC(size)
#define STk_must_realloc(ptr, size)     GC_REALLOC((ptr), (size))
#define STk_free(ptr)                   GC_FREE(ptr)
#define STk_register_finalizer(ptr, f)  GC_REGISTER_FINALIZER(
</span>                                            <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span><span class="p">),</span>
                                            <span class="p">(</span><span class="n">GC_finalization_proc</span><span class="p">)(</span><span class="n">f</span><span class="p">),</span>
                                            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="cp">#define STk_gc()                        GC_gcollect()
</span>
<span class="kt">void</span> <span class="nf">STk_gc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>STk_must_malloc</code> - used to allocate structured objects.</p>
</li>
<li>
<p><code>STk_must_malloc_atomic</code> - used when there won’t be any pointers
inside the object, and we don’t want to confuse the GC with patterns
that are supposed to be just a bignum, but ``look like apointer''. Used
for strings, numbers etc.</p>
</li>
<li>
<p><code>STk_register_finalizer</code> will register a finalizer function <code>f</code>, which
will be called when the object at <code>ptr</code> is collected.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_c_variables_for_conditional_compilation">11. C variables for conditional compilation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These are simple to understand, but we ist them here anyway.</p>
</div>
<div class="sect2">
<h3 id="_detecting_libffi_libgmp_dynamic_loading">11.1. Detecting libffi, libgmp, dynamic loading</h3>
<div class="ulist">
<ul>
<li>
<p><code>libffi</code>: the <code>configure</code> script will set the <code>HAS_FFI</code> variable when libffi is available. In
<code>ffi.c</code>, for example, the code that actually uses <code>libffi</code> is guarded by an <code>ifdef</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#ifdef HAVE_FFI
</span>    <span class="cm">/* use libffi here */</span>
<span class="cp">#else </span><span class="cm">/* HAVE_FFI */</span><span class="cp">
</span><span class="k">static</span> <span class="kt">void</span> <span class="nf">error_no_ffi</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">STk_error</span><span class="p">(</span><span class="s">"current system does not support FFI"</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="n">DEFINE_PRIMITIVE</span><span class="p">(</span><span class="s">"make-callback"</span><span class="p">,</span> <span class="n">make_callback</span><span class="p">,</span> <span class="n">subr3</span><span class="p">,</span> <span class="p">(</span><span class="n">SCM</span> <span class="n">p1</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">p2</span><span class="p">,</span> <span class="n">SCM</span> <span class="n">p3</span><span class="p">))</span>
<span class="p">{</span> <span class="n">error_no_ffi</span><span class="p">();</span> <span class="k">return</span> <span class="n">STk_void</span><span class="p">;}</span>
<span class="p">...</span>
<span class="cp">#endif</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>libgmp</code>: In <code>number.c</code>, STklos includes &#8220;gmp.h&#8221;. This header file
may be provided either by <code>mini-gmp</code> or by the full GMP. WHen the
<code>mini-gmp</code> is used, the variable <code><em>MINI_GMP_H</em></code> is defined, so
for example this is tone in <code>number.c</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#ifdef __MINI_GMP_H__
</span>    <span class="cm">/* BEGIN code for compiling WITH MINI GMP (*no* rationals!) */</span>
    <span class="p">...</span>
<span class="cp">#else
</span>    <span class="cm">/* BEGIN code for compiling WITH FULL GMP (*with* rationals!) */</span>
    <span class="p">...</span>
<span class="cp">#endif </span><span class="cm">/* __MINI_GMP_H__ */</span><span class="cp">
</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In <code>dynload.c</code>, the variable <code>HAVE_DLOPEN</code> is used to guard the full contents of the file.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_statistics_gathering">11.2. Statistics gathering</h3>
<div class="paragraph">
<p>In <code>vm.c</code>, code that does statistics gathering is guarded by <code>STAT_VM</code>. For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#ifdef STAT_VM
</span><span class="k">static</span> <span class="kt">int</span> <span class="n">couple_instr</span><span class="p">[</span><span class="n">NB_VM_INSTR</span><span class="p">][</span><span class="n">NB_VM_INSTR</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cpt_inst</span><span class="p">[</span><span class="n">NB_VM_INSTR</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">double</span> <span class="n">time_inst</span><span class="p">[</span><span class="n">NB_VM_INSTR</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">collect_stats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tick</span><span class="p">(</span><span class="n">STk_instr</span> <span class="n">b</span><span class="p">,</span> <span class="n">STk_instr</span> <span class="o">*</span><span class="n">previous_op</span><span class="p">,</span> <span class="kt">clock_t</span> <span class="o">*</span><span class="n">previous_time</span><span class="p">);</span>
<span class="cp">#endif</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>